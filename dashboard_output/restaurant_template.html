<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{restaurant_name}} - Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f8fafc;
            --bg-card: #ffffff;
            --bg-hover: #f1f5f9;
            --text-primary: #0f172a;
            --text-secondary: #64748b;
            --text-muted: #94a3b8;
            --border: #e2e8f0;
            --accent: #ef4444;
            --accent-hover: #dc2626;
            --green: #22c55e;
            --red: #ef4444;
            --shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        [data-theme="dark"] {
            --bg-primary: #000000;
            --bg-secondary: #0a0a0a;
            --bg-card: #0f0f0f;
            --bg-hover: #1a1a1a;
            --text-primary: #ffffff;
            --text-secondary: #a0a0a0;
            --text-muted: #666666;
            --border: #1f1f1f;
            --shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
            --shadow-lg: 0 4px 6px -1px rgba(0, 0, 0, 0.6);
        }
        
        body {
            font-family: 'Inter', system-ui, sans-serif;
            background: var(--bg-secondary);
            color: var(--text-primary);
            line-height: 1.6;
            transition: background-color 0.3s, color 0.3s;
        }
        
        .dashboard { max-width: 1400px; margin: 0 auto; padding: 2rem; }




        .interruption-banner {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 50%, #991b1b 100%);
            border: 2px solid #fca5a5;
            border-radius: 16px;
            padding: 1.25rem 1.75rem;
            margin-bottom: 1.5rem;
            display: none;
            align-items: center;
            gap: 1.25rem;
            animation: slideDown 0.5s ease, pulse 2s ease-in-out infinite;
            box-shadow: 0 10px 25px rgba(220, 38, 38, 0.3), 
                        0 4px 10px rgba(220, 38, 38, 0.2),
                        inset 0 1px 0 rgba(255, 255, 255, 0.1);
            position: relative;
            overflow: hidden;
        }
        .interruption-banner::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, 
                transparent, 
                rgba(255, 255, 255, 0.1), 
                transparent);
            animation: shine 3s infinite;
        }
        .interruption-banner.active { display: flex; }
        @keyframes slideDown {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        @keyframes pulse {
            0%, 100% { box-shadow: 0 10px 25px rgba(220, 38, 38, 0.3), 0 4px 10px rgba(220, 38, 38, 0.2), inset 0 1px 0 rgba(255, 255, 255, 0.1); }
            50% { box-shadow: 0 10px 30px rgba(220, 38, 38, 0.5), 0 4px 15px rgba(220, 38, 38, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.15); }
        }
        @keyframes shine {
            0% { left: -100%; }
            50%, 100% { left: 100%; }
        }



        .interruption-icon {
            width: 48px;
            height: 48px;
            color: #ffffff;
            flex-shrink: 0;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #fca5a5 0%, #f87171 100%);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2),
                        inset 0 -2px 4px rgba(0, 0, 0, 0.1);
            position: relative;
            z-index: 1;
        }
        .interruption-icon svg {
            width: 28px;
            height: 28px;
            color: white;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));
        }
        .interruption-title {
            font-weight: 700;
            font-size: 1rem;
            color: #ffffff;
            margin-bottom: 0.25rem;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            position: relative;
            z-index: 1;
        }
        .interruption-details {
            font-size: 0.875em;
            color: rgba(255, 255, 255, 0.95);
            display: flex;
            gap: 0.75rem;
            position: relative;
            z-index: 1;
        }
        .interruption-time {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            flex-wrap: wrap;
        }
        .closure-overlay {
            position: absolute;
            top: 0;
            bottom: 60px;
            background: repeating-linear-gradient(
                45deg,
                rgba(239, 68, 68, 0.08),
                rgba(239, 68, 68, 0.08) 10px,
                rgba(220, 38, 38, 0.12) 10px,
                rgba(220, 38, 38, 0.12) 20px
            );
            border-left: 3px solid rgba(239, 68, 68, 0.6);
            border-right: 3px solid rgba(239, 68, 68, 0.6);
            pointer-events: none;
            z-index: 1;
            backdrop-filter: blur(1px);
            box-shadow: inset 0 0 20px rgba(239, 68, 68, 0.1);
        }
        .closure-label {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            color: white;
            padding: 0.4rem 1rem;
            border-radius: 8px;
            font-size: 0.75rem;
            font-weight: 700;
            white-space: nowrap;
            z-index: 2;
            box-shadow: 0 4px 12px rgba(220, 38, 38, 0.4),
                        0 2px 4px rgba(0, 0, 0, 0.2);
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }





        .back-link {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 0.875rem;
            margin-bottom: 1.5rem;
            transition: color 0.2s;
        }
        .back-link:hover { color: var(--text-primary); }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .header-info h1 {
            font-size: 1.75rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .header-meta {
            display: flex;
            align-items: center;
            gap: 1rem;
            color: var(--text-secondary);
            font-size: 0.875rem;
        }
        
        .platforms { display: flex; gap: 0.4rem; }
        
        .platform-tag {
            font-size: 0.75rem;
            padding: 0.25rem 0.6rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 4px;
        }
        
        .header-actions { display: flex; gap: 0.5rem; align-items: center; }
        
        .btn {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            font-weight: 500;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            border: 1px solid var(--border);
            background: var(--bg-card);
            color: var(--text-secondary);
        }
        
        .btn:hover { background: var(--bg-hover); color: var(--text-primary); border-color: var(--accent); }
        
        .btn-primary { background: var(--accent); color: white; border-color: var(--accent); }
        .btn-primary:hover { background: var(--accent-hover); }
        
        .api-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.4rem 0.75rem;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 0.75rem;
            color: var(--text-secondary);
        }
        
        .api-status .dot { width: 8px; height: 8px; border-radius: 50%; background: var(--green); }
        .api-status.loading .dot { background: #f59e0b; animation: pulse 1s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        
        /* Date Filter Styles */
        .filter-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding: 1rem 1.25rem;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
        }
        
        .filter-bar-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            color: var(--text-secondary);
            font-size: 0.875rem;
        }
        
        .filter-bar-info svg {
            color: var(--text-muted);
        }
        
        .filter-bar-period {
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .btn-filter {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.625rem 1rem;
            font-size: 0.875rem;
            font-weight: 600;
            color: white;
            background: var(--accent);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-filter:hover {
            background: var(--accent-hover);
        }
        
        .btn-filter svg {
            width: 18px;
            height: 18px;
        }
        
        /* Filter Modal */
        .filter-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }
        
        .filter-modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        .filter-modal {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            width: 100%;
            max-width: 480px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
            transform: translateY(20px);
            transition: transform 0.3s;
        }
        
        .filter-modal-overlay.active .filter-modal {
            transform: translateY(0);
        }
        
        .filter-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--border);
        }
        
        .filter-modal-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .filter-modal-close {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            color: var(--text-secondary);
            transition: all 0.2s;
        }
        
        .filter-modal-close:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }
        
        .filter-modal-body {
            padding: 1.5rem;
        }
        
        .filter-section {
            margin-bottom: 1.5rem;
        }
        
        .filter-section:last-child {
            margin-bottom: 0;
        }
        
        .filter-section-title {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.75rem;
        }
        
        /* Filter Type Radio Buttons */
        .filter-type-options {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .filter-type-option {
            flex: 1;
            position: relative;
        }
        
        .filter-type-option input {
            position: absolute;
            opacity: 0;
            pointer-events: none;
        }
        
        .filter-type-option label {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.625rem 0.75rem;
            font-size: 0.8rem;
            font-weight: 500;
            color: var(--text-secondary);
            background: var(--bg-secondary);
            border: 2px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .filter-type-option input:checked + label {
            color: var(--accent);
            background: rgba(239, 68, 68, 0.08);
            border-color: var(--accent);
        }
        
        .filter-type-option label:hover {
            border-color: var(--accent);
        }
        
        .filter-type-option .radio-dot {
            width: 16px;
            height: 16px;
            border: 2px solid var(--border);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: all 0.2s;
        }
        
        .filter-type-option input:checked + label .radio-dot {
            border-color: var(--accent);
        }
        
        .filter-type-option input:checked + label .radio-dot::after {
            content: '';
            width: 8px;
            height: 8px;
            background: var(--accent);
            border-radius: 50%;
        }
        
        /* Quick Select Buttons */
        .filter-quick-options {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        
        .filter-quick-btn {
            padding: 0.5rem 1rem;
            font-size: 0.8rem;
            font-weight: 500;
            color: var(--text-secondary);
            background: var(--bg-secondary);
            border: 2px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .filter-quick-btn:hover {
            border-color: var(--accent);
            color: var(--text-primary);
        }
        
        .filter-quick-btn.active {
            color: var(--accent);
            background: rgba(239, 68, 68, 0.08);
            border-color: var(--accent);
        }
        
        /* Month Selector */
        .filter-months-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
        }
        
        .filter-month-btn {
            padding: 0.625rem 0.5rem;
            font-size: 0.8rem;
            font-weight: 500;
            color: var(--text-secondary);
            background: var(--bg-secondary);
            border: 2px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }
        
        .filter-month-btn:hover {
            border-color: var(--accent);
            color: var(--text-primary);
        }
        
        .filter-month-btn.active {
            color: var(--accent);
            background: rgba(239, 68, 68, 0.08);
            border-color: var(--accent);
        }
        
        /* Custom Date Inputs */
        .filter-date-inputs {
            display: flex;
            gap: 1rem;
        }
        
        .filter-date-group {
            flex: 1;
        }
        
        .filter-date-label {
            display: block;
            font-size: 0.75rem;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }
        
        .filter-date-input {
            width: 100%;
            padding: 0.625rem 0.875rem;
            font-size: 0.875rem;
            font-family: inherit;
            color: var(--text-primary);
            background: var(--bg-secondary);
            border: 2px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .filter-date-input:focus {
            outline: none;
            border-color: var(--accent);
        }
        
        .filter-date-input::-webkit-calendar-picker-indicator {
            cursor: pointer;
            filter: var(--calendar-filter, none);
        }
        
        [data-theme="dark"] .filter-date-input::-webkit-calendar-picker-indicator {
            filter: invert(1);
        }
        
        /* Modal Footer */
        .filter-modal-footer {
            display: flex;
            gap: 0.75rem;
            padding: 1.25rem 1.5rem;
            border-top: 1px solid var(--border);
        }
        
        .btn-filter-cancel {
            flex: 1;
            padding: 0.75rem 1rem;
            font-size: 0.875rem;
            font-weight: 600;
            font-family: inherit;
            color: var(--text-secondary);
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-filter-cancel:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }
        
        .btn-filter-apply {
            flex: 1;
            padding: 0.75rem 1rem;
            font-size: 0.875rem;
            font-weight: 600;
            font-family: inherit;
            color: white;
            background: var(--accent);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-filter-apply:hover {
            background: var(--accent-hover);
        }
        
        /* Filter content visibility */
        .filter-content {
            display: none;
        }
        
        .filter-content.active {
            display: block;
        }

        .view-tabs {
            display: flex;
            gap: 1rem;
            margin: 0 0 1.5rem 0;
            border-bottom: 1px solid var(--border);
        }
        
        .view-tab {
            padding: 0.75rem 1.5rem;
            background: none;
            border: none;
            font-size: 1rem;
            font-weight: 500;
            color: var(--text-secondary);
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
            margin-bottom: -1px;
        }
        
        .view-tab.active { color: var(--text-primary); border-bottom-color: var(--accent); }
        .view-tab:hover { color: var(--text-primary); }
        
        .view-container { display: none; }
        .view-container.active { display: block; }
        
        .main-kpis {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .kpi-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.25rem;
        }
        
        .kpi-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.75rem;
            font-weight: 500;
        }
        
        .kpi-value {
            font-size: 1.75rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }
        
        .kpi-trend {
            font-size: 0.8rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }
        
        .kpi-trend.positive { color: var(--green); }
        .kpi-trend.negative { color: var(--red); }
        
        .metrics-section {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            margin-bottom: 1.5rem;
            overflow: hidden;
        }
        
        .metrics-section-header {
            padding: 1rem 1.5rem;
            font-weight: 600;
            font-size: 0.95rem;
            border-bottom: 1px solid var(--border);
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .metrics-section-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        }
        
        .section-metric {
            padding: 1.25rem;
            text-align: center;
            border-right: 1px solid var(--border);
            border-bottom: 1px solid var(--border);
        }
        
        .section-metric:last-child { border-right: none; }
        
        .section-metric-label {
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.5rem;
        }
        
        .section-metric-value {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 0.35rem;
            color: var(--text-primary);
        }
        
        .section-metric-trend { font-size: 0.75rem; font-weight: 500; }
        .section-metric-trend.positive { color: var(--green); }
        .section-metric-trend.negative { color: var(--red); }
        
        .chart-section {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            margin-bottom: 2rem;
            overflow: hidden;
        }
        
        .chart-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .chart-title { font-weight: 600; }
        
        .column-tabs { display: flex; gap: 0.25rem; flex-wrap: wrap; }
        
        .column-tab {
            padding: 0.4rem 0.75rem;
            font-size: 0.75rem;
            font-weight: 500;
            color: var(--text-secondary);
            background: var(--bg-secondary);
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .column-tab:hover { background: var(--bg-hover); color: var(--text-primary); }
        .column-tab.active { background: var(--accent); color: white; }
        
        .chart-filters {
            display: flex;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }
        
        .filter-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .filter-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            font-weight: 500;
        }
        
        .filter-select {
            padding: 0.65rem 2.75rem 0.65rem 1.1rem;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-primary);
            background: var(--bg-card);
            border: 2px solid var(--border);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            min-width: 140px;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='14' height='14' viewBox='0 0 24 24' fill='none' stroke='%2364748b' stroke-width='2.5' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 14px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
            position: relative;
        }
        
        .filter-select:hover { 
            border-color: var(--accent); 
            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.12);
            transform: translateY(-1px);
        }
        
        .filter-select:focus { 
            outline: none; 
            border-color: var(--accent); 
            box-shadow: 0 0 0 4px rgba(239, 68, 68, 0.12), 0 2px 8px rgba(239, 68, 68, 0.15); 
            transform: translateY(-1px);
        }
        
        .filter-select:active {
            transform: translateY(0);
            box-shadow: 0 1px 3px rgba(239, 68, 68, 0.15);
        }
        
        /* Enhanced option styling */
        .filter-select option {
            padding: 0.75rem 1rem;
            background: var(--bg-card);
            color: var(--text-primary);
            font-weight: 500;
        }
        
        .filter-select option:hover {
            background: var(--bg-hover);
        }
        
        .filter-select option:checked {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.1) 0%, rgba(239, 68, 68, 0.15) 100%);
            color: var(--accent);
            font-weight: 600;
        }
        
        /* Dark theme adjustments for dropdown */
        [data-theme="dark"] .filter-select {
            border-color: #2a2a2a;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='14' height='14' viewBox='0 0 24 24' fill='none' stroke='%23a0a0a0' stroke-width='2.5' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
        }
        
        [data-theme="dark"] .filter-select:hover {
            border-color: var(--accent);
            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.2);
        }
        
        [data-theme="dark"] .filter-select:focus {
            box-shadow: 0 0 0 4px rgba(239, 68, 68, 0.18), 0 2px 8px rgba(239, 68, 68, 0.25);
        }
        
        .view-toggle {
            display: flex;
            gap: 0.25rem;
            background: var(--bg-secondary);
            padding: 0.25rem;
            border-radius: 8px;
        }
        
        .view-toggle-btn {
            padding: 0.4rem 0.75rem;
            font-size: 0.7rem;
            font-weight: 500;
            color: var(--text-secondary);
            background: transparent;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .view-toggle-btn:hover { color: var(--text-primary); }
        .view-toggle-btn.active { background: var(--bg-card); color: var(--text-primary); box-shadow: var(--shadow); }
        
        .chart-container { padding: 1.5rem; }
        .chart-wrapper { position: relative; height: 320px; }
        
        .chart-stats {
            display: flex;
            gap: 2rem;
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--border);
            background: var(--bg-secondary);
            flex-wrap: wrap;
        }
        
        .stat { font-size: 0.8rem; color: var(--text-secondary); }
        .stat strong { color: var(--text-primary); }
        
        .data-section {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 1.5rem;
        }
        
        .section-header {
            padding: 1rem 1.5rem;
            font-weight: 600;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
        }
        
        .table-container { overflow-x: auto; }
        
        .orders-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }
        
        .orders-table th {
            padding: 0.75rem 1rem;
            text-align: left;
            font-weight: 600;
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
        }
        
        .orders-table td {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--border);
            color: var(--text-primary);
        }
        
        .orders-table tr:hover td { background: var(--bg-hover); }
        
        .order-status {
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .order-status.concluded { background: rgba(34,197,94,0.1); color: var(--green); }
        .order-status.confirmed { background: rgba(59,130,246,0.1); color: #3b82f6; }
        .order-status.cancelled { background: rgba(239,68,68,0.1); color: var(--red); }
        
        .no-data { padding: 3rem; text-align: center; color: var(--text-secondary); }
        
        .loading-state { text-align: center; padding: 3rem; color: var(--text-secondary); }
        .loading-spinner { width: 40px; height: 40px; border: 3px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 1rem; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .hourly-chart { margin-top: 1.5rem; }
        
        @media (max-width: 768px) {
            .dashboard { padding: 1rem; }
            .chart-wrapper { height: 250px; }
            .view-tabs { flex-wrap: wrap; }
            .main-kpis { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body>
    <div class="interruption-banner" id="interruptionBanner">
    <div class="interruption-icon">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
        </svg>
    </div>
    <div class="interruption-content">
        <div class="interruption-title">Restaurante Fechado Temporariamente</div>
        <div class="interruption-details" id="interruptionDetails"></div>
    </div>
    </div>
    <div class="dashboard">
        <a href="/dashboard" class="back-link">
            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
            </svg>
            Voltar para Clientes
        </a>
        
        <div class="header">
            <div class="header-info">
                <h1 id="restaurantName">{{restaurant_name}}</h1>
                <div class="header-meta">
                    <span id="restaurantManager">ðŸ‘¤ {{restaurant_manager}}</span>
                    <div class="platforms" id="platforms">
                        <span class="platform-tag">iFood</span>
                    </div>
                </div>
            </div>
            <div class="header-actions">
                <div class="api-status" id="apiStatus">
                    <span class="dot"></span>
                    <span>iFood API</span>
                </div>
                <button class="btn" onclick="refreshData()" title="Atualizar dados">
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
                </button>
                <button class="btn" id="themeToggle" onclick="toggleTheme()" title="Alternar tema">
                    <svg id="sunIcon" width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="display:none;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"/></svg>
                    <svg id="moonIcon" width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/></svg>
                </button>
            </div>
        </div>
        
        <div class="view-tabs">
            <button class="view-tab active" data-view="dashboard">Dashboard</button>
            <button class="view-tab" data-view="orders">Pedidos</button>
            <button class="view-tab" data-view="hourly">Por Hora</button>
        </div>
        
        <!-- Filter Bar -->
        <div class="filter-bar">
            <div class="filter-bar-info">
                <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                </svg>
                <span>Periodo:</span>
                <span class="filter-bar-period" id="filterPeriodLabel">Ultimos 7 dias</span>
            </div>
            <button class="btn-filter" onclick="openFilterModal()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="4" y1="21" x2="4" y2="14"></line>
                    <line x1="4" y1="10" x2="4" y2="3"></line>
                    <line x1="12" y1="21" x2="12" y2="12"></line>
                    <line x1="12" y1="8" x2="12" y2="3"></line>
                    <line x1="20" y1="21" x2="20" y2="16"></line>
                    <line x1="20" y1="12" x2="20" y2="3"></line>
                    <line x1="1" y1="14" x2="7" y2="14"></line>
                    <line x1="9" y1="8" x2="15" y2="8"></line>
                    <line x1="17" y1="16" x2="23" y2="16"></line>
                </svg>
                Alterar filtros
            </button>
        </div>
        
        <!-- Filter Modal -->
        <div class="filter-modal-overlay" id="filterModal">
            <div class="filter-modal">
                <div class="filter-modal-header">
                    <span class="filter-modal-title">Filtrar por periodo</span>
                    <button class="filter-modal-close" onclick="closeFilterModal()">
                        <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
                <div class="filter-modal-body">
                    <div class="filter-section">
                        <div class="filter-section-title">Tipos de filtro</div>
                        <div class="filter-type-options">
                            <div class="filter-type-option">
                                <input type="radio" name="filterType" id="filterTypeCurrent" value="current" checked>
                                <label for="filterTypeCurrent">
                                    <span class="radio-dot"></span>
                                    Periodo corrente
                                </label>
                            </div>
                            <div class="filter-type-option">
                                <input type="radio" name="filterType" id="filterTypeMonth" value="month">
                                <label for="filterTypeMonth">
                                    <span class="radio-dot"></span>
                                    Mes fechado
                                </label>
                            </div>
                            <div class="filter-type-option">
                                <input type="radio" name="filterType" id="filterTypeCustom" value="custom">
                                <label for="filterTypeCustom">
                                    <span class="radio-dot"></span>
                                    Personalizado
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Current Period Options -->
                    <div class="filter-content active" id="filterContentCurrent">
                        <div class="filter-quick-options">
                            <button class="filter-quick-btn" data-period="today">Hoje</button>
                            <button class="filter-quick-btn active" data-period="7days">Ult. 7 dias</button>
                            <button class="filter-quick-btn" data-period="30days">Ult. 30 dias</button>
                        </div>
                    </div>
                    
                    <!-- Month Selection -->
                    <div class="filter-content" id="filterContentMonth">
                        <div class="filter-months-grid" id="filterMonthsGrid">
                            <!-- Months will be populated dynamically -->
                        </div>
                    </div>
                    
                    <!-- Custom Date Range -->
                    <div class="filter-content" id="filterContentCustom">
                        <div class="filter-date-inputs">
                            <div class="filter-date-group">
                                <label class="filter-date-label">Data inicial</label>
                                <input type="date" class="filter-date-input" id="filterDateStart">
                            </div>
                            <div class="filter-date-group">
                                <label class="filter-date-label">Data final</label>
                                <input type="date" class="filter-date-input" id="filterDateEnd">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="filter-modal-footer">
                    <button class="btn-filter-cancel" onclick="closeFilterModal()">Cancelar</button>
                    <button class="btn-filter-apply" onclick="applyFilter()">Aplicar filtro</button>
                </div>
            </div>
        </div>
        
        <div id="dashboardView" class="view-container active">
            <div class="main-kpis" id="mainKpis">
                <div class="loading-state"><div class="loading-spinner"></div><p>Carregando metricas...</p></div>
            </div>
            
            <div id="metricsSections"></div>
            
            <div class="chart-section">
                <div class="chart-header">
                    <div class="chart-title">Evolucao Diaria</div>
                    <div class="chart-filters">
                        <div class="column-tabs" id="columnTabs"></div>
                    </div>
                </div>
                <div class="chart-container">
                    <div class="chart-wrapper">
                        <canvas id="mainChart"></canvas>
                    </div>
                </div>
                <div class="chart-stats" id="chartStats"></div>
            </div>
        </div>
        
        <div id="ordersView" class="view-container">
            <div class="data-section">
                <div class="section-header">Ultimos Pedidos</div>
                <div class="table-container" id="ordersTableContainer">
                    <div class="loading-state"><div class="loading-spinner"></div><p>Carregando pedidos...</p></div>
                </div>
            </div>
        </div>
        
        <div id="hourlyView" class="view-container">
            <div class="chart-section">
                <div class="chart-header">
                    <div class="chart-title">Pedidos por Hora do Dia</div>
                </div>
                <div class="chart-container">
                    <div class="chart-wrapper">
                        <canvas id="hourlyChart"></canvas>
                    </div>
                </div>
            </div>
            
            <div class="metrics-section">
                <div class="metrics-section-header">
                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                    Analise por Horario
                </div>
                <div class="metrics-section-grid" id="hourlyStats"></div>
            </div>
        </div>
    </div>

    <script>
        const restaurantId = '{{restaurant_id}}';
        let restaurantData = null;
        let chartsData = null;
        let ordersData = [];
        let mainChart = null;
        let hourlyChart = null;
        let activeChartType = 'revenue';
        
        // New filter system variables
        let currentFilter = {
            type: 'current',      // 'current', 'month', 'custom'
            period: '7days',      // 'today', '7days', '30days' (for current type)
            month: null,          // 'YYYY-MM' (for month type)
            startDate: null,      // Date object (for custom type)
            endDate: null         // Date object (for custom type)
        };
        let availableMonths = []; // List of available months from data

        const colorPalette = [
            { border: '#ef4444', bg: 'rgba(239, 68, 68, 0.1)' },
            { border: '#3b82f6', bg: 'rgba(59, 130, 246, 0.1)' },
            { border: '#22c55e', bg: 'rgba(34, 197, 94, 0.1)' },
            { border: '#f59e0b', bg: 'rgba(245, 158, 11, 0.1)' },
            { border: '#8b5cf6', bg: 'rgba(139, 92, 246, 0.1)' }
        ];
        
        // ============================================================================
        // FILTER MODAL FUNCTIONS
        // ============================================================================
        
        function openFilterModal() {
            document.getElementById('filterModal').classList.add('active');
            document.body.style.overflow = 'hidden';
            populateMonthsGrid();
            syncModalWithCurrentFilter();
        }
        
        function closeFilterModal() {
            document.getElementById('filterModal').classList.remove('active');
            document.body.style.overflow = '';
        }
        
        function syncModalWithCurrentFilter() {
            // Set the correct filter type radio
            const typeRadio = document.querySelector(`input[name="filterType"][value="${currentFilter.type}"]`);
            if (typeRadio) {
                typeRadio.checked = true;
                updateFilterContent(currentFilter.type);
            }
            
            // Set the correct quick button for current type
            if (currentFilter.type === 'current') {
                document.querySelectorAll('#filterContentCurrent .filter-quick-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.period === currentFilter.period);
                });
            }
            
            // Set the correct month button
            if (currentFilter.type === 'month' && currentFilter.month) {
                document.querySelectorAll('#filterMonthsGrid .filter-month-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.month === currentFilter.month);
                });
            }
            
            // Set custom dates
            if (currentFilter.type === 'custom') {
                if (currentFilter.startDate) {
                    document.getElementById('filterDateStart').value = formatDateForInput(currentFilter.startDate);
                }
                if (currentFilter.endDate) {
                    document.getElementById('filterDateEnd').value = formatDateForInput(currentFilter.endDate);
                }
            }
        }
        
        function updateFilterContent(type) {
            // Hide all filter contents
            document.querySelectorAll('.filter-content').forEach(el => el.classList.remove('active'));
            
            // Show selected content
            const contentId = `filterContent${type.charAt(0).toUpperCase() + type.slice(1)}`;
            const content = document.getElementById(contentId);
            if (content) {
                content.classList.add('active');
            }
        }
        
        function populateMonthsGrid() {
            const grid = document.getElementById('filterMonthsGrid');
            if (!grid) return;
            
            // Get months from chart data or generate last 6 months
            let months = [];
            if (chartsData && chartsData.available_months && chartsData.available_months.length > 0) {
                months = chartsData.available_months.slice().reverse(); // Most recent first
            } else {
                // Generate last 6 months
                const now = new Date();
                for (let i = 0; i < 6; i++) {
                    const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
                    const monthKey = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
                    const monthLabel = d.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
                    months.push({ value: monthKey, label: monthLabel.charAt(0).toUpperCase() + monthLabel.slice(1) });
                }
            }
            
            availableMonths = months;
            
            grid.innerHTML = months.map(m => 
                `<button class="filter-month-btn${currentFilter.month === m.value ? ' active' : ''}" data-month="${m.value}">${m.label}</button>`
            ).join('');
            
            // Add click handlers
            grid.querySelectorAll('.filter-month-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    grid.querySelectorAll('.filter-month-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                });
            });
        }
        
        function applyFilter() {
            const filterType = document.querySelector('input[name="filterType"]:checked').value;
            
            currentFilter.type = filterType;
            
            if (filterType === 'current') {
                const activeBtn = document.querySelector('#filterContentCurrent .filter-quick-btn.active');
                currentFilter.period = activeBtn ? activeBtn.dataset.period : '7days';
                currentFilter.month = null;
                currentFilter.startDate = null;
                currentFilter.endDate = null;
            } else if (filterType === 'month') {
                const activeMonth = document.querySelector('#filterMonthsGrid .filter-month-btn.active');
                currentFilter.month = activeMonth ? activeMonth.dataset.month : null;
                currentFilter.period = null;
                currentFilter.startDate = null;
                currentFilter.endDate = null;
            } else if (filterType === 'custom') {
                const startInput = document.getElementById('filterDateStart').value;
                const endInput = document.getElementById('filterDateEnd').value;
                currentFilter.startDate = startInput ? new Date(startInput) : null;
                currentFilter.endDate = endInput ? new Date(endInput) : null;
                currentFilter.period = null;
                currentFilter.month = null;
            }
            
            closeFilterModal();
            updateFilterLabel();
            reloadDataWithFilter();
        }
        
        function getFilterDateRange() {
            const now = new Date();
            let startDate, endDate;
            
            if (currentFilter.type === 'current') {
                endDate = now;
                switch (currentFilter.period) {
                    case 'today':
                        startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                        break;
                    case '7days':
                        startDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                        break;
                    case '30days':
                    default:
                        startDate = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                        break;
                }
            } else if (currentFilter.type === 'month' && currentFilter.month) {
                const [year, month] = currentFilter.month.split('-').map(Number);
                startDate = new Date(year, month - 1, 1);
                endDate = new Date(year, month, 0); // Last day of month
            } else if (currentFilter.type === 'custom') {
                startDate = currentFilter.startDate || new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                endDate = currentFilter.endDate || now;
            } else {
                // Default to last 7 days
                startDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                endDate = now;
            }
            
            return { startDate, endDate };
        }
        
        function formatDateForInput(date) {
            if (!date) return '';
            const d = new Date(date);
            return d.toISOString().split('T')[0];
        }
        
        function formatDateForDisplay(date) {
            if (!date) return '';
            return new Date(date).toLocaleDateString('pt-BR');
        }
        
        function updateFilterLabel() {
            const label = document.getElementById('filterPeriodLabel');
            if (!label) return;
            
            let text = '';
            
            if (currentFilter.type === 'current') {
                switch (currentFilter.period) {
                    case 'today':
                        const today = new Date();
                        text = formatDateForDisplay(today);
                        break;
                    case '7days':
                        text = 'Ultimos 7 dias';
                        break;
                    case '30days':
                        text = 'Ultimos 30 dias';
                        break;
                    default:
                        text = 'Ultimos 7 dias';
                }
            } else if (currentFilter.type === 'month' && currentFilter.month) {
                const [year, month] = currentFilter.month.split('-').map(Number);
                const date = new Date(year, month - 1, 1);
                text = date.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
                text = text.charAt(0).toUpperCase() + text.slice(1);
            } else if (currentFilter.type === 'custom') {
                const { startDate, endDate } = getFilterDateRange();
                text = `${formatDateForDisplay(startDate)} - ${formatDateForDisplay(endDate)}`;
            }
            
            label.textContent = text;
        }
        
        async function reloadDataWithFilter() {
            setLoading(true);
            
            try {
                const { startDate, endDate } = getFilterDateRange();
                const startStr = formatDateForInput(startDate);
                const endStr = formatDateForInput(endDate);
                
                // Build URL with filter parameters
                let url = `/api/restaurant/${restaurantId}?start_date=${startStr}&end_date=${endStr}`;
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.success) {
                    restaurantData = data.restaurant;
                    chartsData = data.charts || {};
                    
                    // Filter chart data based on date range
                    filterChartsDataByDateRange(startDate, endDate);
                    
                    renderMainKpis();
                    renderMetricsSections();
                    updateMainChart();
                    
                    // Update hourly if visible
                    if (document.getElementById('hourlyView').classList.contains('active')) {
                        renderHourlyChart();
                    }
                    
                    // Reload orders if orders tab is active
                    if (document.getElementById('ordersView').classList.contains('active')) {
                        loadOrders();
                    }
                    
                    fetchInterruptions();
                }
            } catch (error) {
                console.error('Error reloading data with filter:', error);
            } finally {
                setLoading(false);
            }
        }
        
        function filterChartsDataByDateRange(startDate, endDate) {
            if (!chartsData || !chartsData.revenue_chart) return;
            
            const start = new Date(startDate);
            const end = new Date(endDate);
            end.setHours(23, 59, 59, 999);
            
            // Filter daily data
            ['revenue_chart', 'orders_chart'].forEach(chartKey => {
                const chart = chartsData[chartKey];
                if (!chart || !chart.dates) return;
                
                const filteredIndices = [];
                chart.dates.forEach((dateStr, idx) => {
                    const date = new Date(dateStr);
                    if (date >= start && date <= end) {
                        filteredIndices.push(idx);
                    }
                });
                
                if (filteredIndices.length > 0) {
                    chartsData[chartKey] = {
                        labels: filteredIndices.map(i => chart.labels[i]),
                        datasets: [{
                            ...chart.datasets[0],
                            data: filteredIndices.map(i => chart.datasets[0].data[i])
                        }],
                        dates: filteredIndices.map(i => chart.dates[i]),
                        months: chart.months ? filteredIndices.map(i => chart.months[i]) : []
                    };
                }
            });
        }
        
        // ============================================================================
        // FILTER EVENT LISTENERS SETUP
        // ============================================================================
        
        function initializeFilterListeners() {
            // Filter type radio buttons
            document.querySelectorAll('input[name="filterType"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    updateFilterContent(this.value);
                });
            });
            
            // Quick period buttons
            document.querySelectorAll('#filterContentCurrent .filter-quick-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('#filterContentCurrent .filter-quick-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                });
            });
            
            // Close modal on overlay click
            document.getElementById('filterModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeFilterModal();
                }
            });
            
            // Close modal on Escape key
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closeFilterModal();
                }
            });
            
            // Set default date inputs
            const now = new Date();
            const sevenDaysAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
            document.getElementById('filterDateStart').value = formatDateForInput(sevenDaysAgo);
            document.getElementById('filterDateEnd').value = formatDateForInput(now);
        }

        function formatCurrency(value) {
            if (!value && value !== 0) return 'R$ 0,00';
            return 'R$ ' + value.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }
        
        function formatNumber(value) {
            if (!value && value !== 0) return '0';
            return value.toLocaleString('pt-BR', { maximumFractionDigits: 0 });
        }
        
        function formatTrend(value) {
            if (!value && value !== 0) return '+0%';
            const sign = value >= 0 ? '+' : '';
            return sign + value.toFixed(2) + '%';
        }
        
        function formatDate(dateStr) {
            if (!dateStr) return '-';
            try {
                const date = new Date(dateStr);
                return date.toLocaleDateString('pt-BR') + ' ' + date.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
            } catch { return dateStr; }
        }
        
        function setLoading(loading) {
            const status = document.getElementById('apiStatus');
            if (loading) {
                status.classList.add('loading');
            } else {
                status.classList.remove('loading');
            }
        }
        
        async function refreshData() {
            // Reload data with current filter
            await reloadDataWithFilter();
        }
        
        function switchTab(tabName) {
            console.log('Switching to tab:', tabName);
            
            // Update tab buttons (they use class="view-tab" and data-view)
            document.querySelectorAll('.view-tab').forEach(btn => {
                if (btn.getAttribute('data-view') === tabName) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
            
            // Update content containers (they have IDs like "dashboardView", "ordersView", "hourlyView")
            document.querySelectorAll('.view-container').forEach(content => {
                if (content.id === `${tabName}View`) {
                    content.classList.add('active');
                } else {
                    content.classList.remove('active');
                }
            });
            
            // Load data for specific tabs
            if (tabName === 'orders' && ordersData.length === 0) {
                loadOrders();
            } else if (tabName === 'hourly' && chartsData) {
                // Render hourly chart when switching to hourly tab
                console.log('Rendering hourly chart...');
                renderHourlyChart();
            }
        }
        
        function switchChartTab(chartName) {
            console.log('Switching to chart:', chartName);
            
            // Update chart tab buttons
            document.querySelectorAll('.chart-tab-btn').forEach(btn => {
                if (btn.dataset.chart === chartName) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
            
            // Update main chart
            updateMainChart(chartName);
        }
        
        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            
            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            
            console.log('Theme changed to:', newTheme);
            
            // Update chart colors if charts exist
            if (mainChart) {
                updateMainChart();
            }
        }
        
        async function fetchInterruptions() {
            try {
                const restaurantId = '{{restaurant_id}}';
                const response = await fetch(`/api/restaurant/${restaurantId}/interruptions`);
                const data = await response.json();
                
                if (data.success && data.interruptions) {
                    // Make sure restaurantData exists before setting interruptions
                    if (!restaurantData) {
                        restaurantData = {};
                    }
                    restaurantData.interruptions = data.interruptions;
                    displayInterruptions();
                    updateHourlyChartWithInterruptions();
                }
            } catch (error) {
                console.error('Error fetching interruptions:', error);
            }
        }
        function displayInterruptions() {
            const banner = document.getElementById('interruptionBanner');
            const details = document.getElementById('interruptionDetails');
            
            // Safety check
            if (!restaurantData || !restaurantData.interruptions || restaurantData.interruptions.length === 0) {
                if (banner) banner.classList.remove('active');
                return;
            }
            
            if (!banner || !details) return; // Elements not found
            
            banner.classList.add('active');
            
            const interruption = restaurantData.interruptions[0];
            const start = new Date(interruption.start);
            const end = new Date(interruption.end);
            
            details.innerHTML = `
                <span class="interruption-time">
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    ${start.toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'})} - 
                    ${end.toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'})}
                </span>
                <span>${interruption.description || 'Fechado temporariamente'}</span>
        <span style="color: var(--text-muted);">â€¢ ${start.toLocaleDateString('pt-BR')}</span>
    `;
 }

 function addClosureOverlays() {
    const container = document.querySelector('.chart-container');
    if (!container) return;
    
    // Remove old overlays
    container.querySelectorAll('.closure-overlay').forEach(el => el.remove());
    
    if (!restaurantData.interruptions || restaurantData.interruptions.length === 0) {
        return;
    }
    
    restaurantData.interruptions.forEach(interruption => {
        const start = new Date(interruption.start);
        const end = new Date(interruption.end);
        
        const startHour = start.getHours();
        const endHour = end.getHours();
        
        // Calculate position as percentage
        const leftPercent = (startHour / 24) * 100;
        const widthPercent = ((endHour - startHour) / 24) * 100;
        
        const overlay = document.createElement('div');
        overlay.className = 'closure-overlay';
        overlay.style.left = `${leftPercent}%`;
        overlay.style.width = `${widthPercent}%`;
        
        const label = document.createElement('div');
        label.className = 'closure-label';
        label.textContent = `ðŸš« Fechado ${start.toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'})}-${end.toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'})}`;
        
        overlay.appendChild(label);
        container.insertBefore(overlay, container.firstChild);
    });
 }

 function updateHourlyChartWithInterruptions() {
    // This function would update your Chart.js instance
    // to color bars red during interruptions
    
    if (!window.hourlyChart) return;
    
    const data = window.hourlyChart.data.datasets[0].data;
    const colors = data.map((value, index) => {
        const isClosed = restaurantData.interruptions?.some(int => {
            const start = new Date(int.start);
            const end = new Date(int.end);
            return index >= start.getHours() && index < end.getHours();
        });
        
        return isClosed ? 'rgba(239, 68, 68, 0.6)' : 'rgba(34, 197, 94, 0.8)';
    });
    
    window.hourlyChart.data.datasets[0].backgroundColor = colors;
    window.hourlyChart.update();
}

        document.addEventListener('DOMContentLoaded', function() {
            // fetchInterruptions will be called after restaurant data loads
            // Refresh interruptions every 5 minutes
            setInterval(fetchInterruptions, 5 * 60 * 1000);
        });
        
        async function loadRestaurantData() {
            setLoading(true);
            try {
                // Build URL with filter parameters
                const { startDate, endDate } = getFilterDateRange();
                const startStr = formatDateForInput(startDate);
                const endStr = formatDateForInput(endDate);
                
                const response = await fetch(`/api/restaurant/${restaurantId}?start_date=${startStr}&end_date=${endStr}`);
                const data = await response.json();
                
                if (data.success) {
                    restaurantData = data.restaurant;
                    chartsData = data.charts || {};
                    
                    // Filter chart data based on date range
                    filterChartsDataByDateRange(startDate, endDate);
                    
                    // Get available months for filter modal
                    if (chartsData.available_months) {
                        availableMonths = chartsData.available_months;
                    }
                    
                    renderMainKpis();
                    renderMetricsSections();
                    renderChartTabs();
                    updateMainChart();
                    
                    // Fetch interruptions AFTER restaurant data is loaded
                    fetchInterruptions();
                }
            } catch (error) {
                console.error('Error loading restaurant data:', error);
                document.getElementById('mainKpis').innerHTML = '<div class="no-data">Erro ao carregar dados</div>';
            } finally {
                setLoading(false);
            }
        }
        
        async function loadOrders() {
            const container = document.getElementById('ordersTableContainer');
            container.innerHTML = '<div class="loading-state"><div class="loading-spinner"></div><p>Carregando pedidos...</p></div>';
            
            try {
                const response = await fetch(`/api/restaurant/${restaurantId}/orders?per_page=100`);
                const data = await response.json();
                
                if (data.success) {
                    ordersData = data.orders || [];
                    renderOrdersTable();
                }
            } catch (error) {
                console.error('Error loading orders:', error);
                container.innerHTML = '<div class="no-data">Erro ao carregar pedidos</div>';
            }
        }
        
        function renderMainKpis() {
            const container = document.getElementById('mainKpis');
            if (!restaurantData || !restaurantData.metrics) {
                container.innerHTML = '<div class="no-data">Sem dados disponiveis</div>';
                return;
            }
            
            const m = restaurantData.metrics;
            const t = m.trends || {};
            
            // Calculate % de desconto if not provided
            const percentDesconto = m.percent_desconto ?? (m.valor_bruto > 0 ? (m.descontos / m.valor_bruto * 100) : 0);
            const trendDesconto = t.percent_desconto ?? t.descontos ?? 0;
            
            container.innerHTML = `
                <div class="kpi-card">
                    <div class="kpi-label">Vendas</div>
                    <div class="kpi-value">${formatNumber(m.vendas)}</div>
                    <div class="kpi-trend ${(t.vendas || 0) >= 0 ? 'positive' : 'negative'}">${formatTrend(t.vendas)}</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">Ticket Medio</div>
                    <div class="kpi-value">${formatCurrency(m.ticket_medio)}</div>
                    <div class="kpi-trend ${(t.ticket_medio || 0) >= 0 ? 'positive' : 'negative'}">${formatTrend(t.ticket_medio)}</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">Novos Clientes</div>
                    <div class="kpi-value">${formatNumber(m.novos_clientes ?? 0)}</div>
                    <div class="kpi-trend ${(t.novos_clientes || 0) >= 0 ? 'positive' : 'negative'}">${formatTrend(t.novos_clientes)}</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">% de Desconto</div>
                    <div class="kpi-value">${percentDesconto.toFixed(2)}%</div>
                    <div class="kpi-trend ${(trendDesconto || 0) <= 0 ? 'positive' : 'negative'}">${formatTrend(trendDesconto)}</div>
                </div>
            `;
        }
        
        function renderMetricsSections() {
            const container = document.getElementById('metricsSections');
            if (!restaurantData || !restaurantData.metrics) {
                container.innerHTML = '';
                return;
            }
            
            const m = restaurantData.metrics;
            const t = m.trends || {};
            
            // Calculate additional metrics
            const margemLiquida = m.valor_bruto > 0 ? ((m.liquido / m.valor_bruto) * 100) : 0;
            const percentDesconto = m.percent_desconto ?? (m.valor_bruto > 0 ? (m.descontos / m.valor_bruto * 100) : 0);
            const trendDesconto = t.percent_desconto ?? t.descontos ?? 0;
            
            container.innerHTML = `
                <div class="metrics-section">
                    <div class="metrics-section-header">
                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                        Resumo Financeiro
                    </div>
                    <div class="metrics-section-grid">
                        <div class="section-metric">
                            <div class="section-metric-label">Valor Bruto</div>
                            <div class="section-metric-value">${formatCurrency(m.valor_bruto)}</div>
                            <div class="section-metric-trend ${(t.valor_bruto || 0) >= 0 ? 'positive' : 'negative'}">${formatTrend(t.valor_bruto)}</div>
                        </div>
                        <div class="section-metric">
                            <div class="section-metric-label">Via Loja</div>
                            <div class="section-metric-value">${formatCurrency(m.via_loja ?? 0)}</div>
                            <div class="section-metric-trend ${(t.via_loja || 0) >= 0 ? 'positive' : 'negative'}">${formatTrend(t.via_loja)}</div>
                        </div>
                        <div class="section-metric">
                            <div class="section-metric-label">Descontos</div>
                            <div class="section-metric-value">${formatCurrency(m.descontos ?? 0)}</div>
                            <div class="section-metric-trend ${(t.descontos || 0) <= 0 ? 'positive' : 'negative'}">${formatTrend(t.descontos)}</div>
                        </div>
                        <div class="section-metric">
                            <div class="section-metric-label">Liquido</div>
                            <div class="section-metric-value">${formatCurrency(m.liquido)}</div>
                            <div class="section-metric-trend ${(t.liquido || 0) >= 0 ? 'positive' : 'negative'}">${formatTrend(t.liquido)}</div>
                        </div>
                        <div class="section-metric">
                            <div class="section-metric-label">% de Desconto</div>
                            <div class="section-metric-value">${percentDesconto.toFixed(2)}%</div>
                            <div class="section-metric-trend ${(trendDesconto || 0) <= 0 ? 'positive' : 'negative'}">${formatTrend(trendDesconto)}</div>
                        </div>
                    </div>
                </div>
                
                <div class="metrics-section">
                    <div class="metrics-section-header">
                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/></svg>
                        Operacao
                    </div>
                    <div class="metrics-section-grid">
                        <div class="section-metric">
                            <div class="section-metric-label">Cancelamentos</div>
                            <div class="section-metric-value">${(m.cancelamentos ?? 0).toFixed(2)}%</div>
                            <div class="section-metric-trend ${(t.cancelamentos || 0) <= 0 ? 'positive' : 'negative'}">${formatTrend(t.cancelamentos)}</div>
                        </div>
                        <div class="section-metric">
                            <div class="section-metric-label">Chamados</div>
                            <div class="section-metric-value">${(m.chamados ?? 0).toFixed(2)}%</div>
                            <div class="section-metric-trend ${(t.chamados || 0) <= 0 ? 'positive' : 'negative'}">${formatTrend(t.chamados)}</div>
                        </div>
                        <div class="section-metric">
                            <div class="section-metric-label">Tempo Aberto</div>
                            <div class="section-metric-value">${(m.tempo_aberto ?? 0).toFixed(2)}%</div>
                            <div class="section-metric-trend ${(t.tempo_aberto || 0) >= 0 ? 'positive' : 'negative'}">${formatTrend(t.tempo_aberto)}</div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function renderChartTabs() {
            const container = document.getElementById('columnTabs');
            const tabs = [
                { id: 'revenue', label: 'Faturamento' },
                { id: 'orders', label: 'Pedidos' }
            ];
            
            container.innerHTML = tabs.map(tab => 
                `<button class="column-tab ${tab.id === activeChartType ? 'active' : ''}" data-type="${tab.id}">${tab.label}</button>`
            ).join('');
            
            container.querySelectorAll('.column-tab').forEach(btn => {
                btn.addEventListener('click', () => {
                    activeChartType = btn.dataset.type;
                    container.querySelectorAll('.column-tab').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    updateMainChart();
                });
            });
        }
        
        function updateMainChart(chartType) {
            // Update active chart type if provided
            if (chartType) {
                activeChartType = chartType;
            }
            
            const ctx = document.getElementById('mainChart').getContext('2d');
            
            if (!chartsData || !chartsData.revenue_chart) {
                if (mainChart) mainChart.destroy();
                document.getElementById('chartStats').innerHTML = '<div class="stat">Sem dados para exibir</div>';
                return;
            }
            
            // Use daily data (already filtered by the global filter)
            const chartConfig = activeChartType === 'revenue' ? chartsData.revenue_chart : chartsData.orders_chart;
            const chartTitle = 'Evolucao Diaria';
            
            // Update chart title
            const titleEl = document.querySelector('.chart-section .chart-title');
            if (titleEl) {
                titleEl.textContent = chartTitle;
            }
            
            if (!chartConfig || !chartConfig.labels || chartConfig.labels.length === 0) {
                if (mainChart) mainChart.destroy();
                document.getElementById('chartStats').innerHTML = '<div class="stat">Sem dados para exibir</div>';
                return;
            }
            
            const colors = colorPalette[activeChartType === 'revenue' ? 0 : 1];
            const dataset = chartConfig.datasets[0] || { data: [] };
            
            if (mainChart) mainChart.destroy();
            
            mainChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: chartConfig.labels,
                    datasets: [{
                        label: dataset.label || (activeChartType === 'revenue' ? 'Faturamento' : 'Pedidos'),
                        data: dataset.data,
                        borderColor: colors.border,
                        backgroundColor: colors.bg,
                        borderWidth: 2,
                        pointRadius: 4,
                        pointHoverRadius: 6,
                        pointBackgroundColor: '#ffffff',
                        pointBorderColor: colors.border,
                        pointBorderWidth: 2,
                        tension: 0.3,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(15, 23, 42, 0.9)',
                            padding: 12,
                            cornerRadius: 8,
                            callbacks: {
                                label: function(context) {
                                    if (activeChartType === 'revenue') {
                                        return formatCurrency(context.raw);
                                    }
                                    return context.raw + ' pedidos';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: document.documentElement.getAttribute('data-theme') === 'dark' ? '#334155' : '#f1f5f9' },
                            ticks: { 
                                color: document.documentElement.getAttribute('data-theme') === 'dark' ? '#94a3b8' : '#64748b',
                                callback: function(value) {
                                    if (activeChartType === 'revenue') {
                                        if (value >= 1000) return 'R$ ' + (value/1000).toFixed(0) + 'K';
                                        return 'R$ ' + value;
                                    }
                                    return value;
                                }
                            }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: document.documentElement.getAttribute('data-theme') === 'dark' ? '#94a3b8' : '#64748b' }
                        }
                    }
                }
            });
            
            // Update stats
            const data = dataset.data.filter(d => d > 0);
            if (data.length > 0) {
                const total = data.reduce((a, b) => a + b, 0);
                const avg = total / data.length;
                const max = Math.max(...data);
                const min = Math.min(...data);
                
                document.getElementById('chartStats').innerHTML = `
                    <div class="stat"><strong>Total:</strong> ${activeChartType === 'revenue' ? formatCurrency(total) : formatNumber(total)}</div>
                    <div class="stat"><strong>Media:</strong> ${activeChartType === 'revenue' ? formatCurrency(avg) : formatNumber(avg)}</div>
                    <div class="stat"><strong>Max:</strong> ${activeChartType === 'revenue' ? formatCurrency(max) : formatNumber(max)}</div>
                    <div class="stat"><strong>Min:</strong> ${activeChartType === 'revenue' ? formatCurrency(min) : formatNumber(min)}</div>
                `;
            }
        }
        
        function renderOrdersTable() {
            const container = document.getElementById('ordersTableContainer');
            
            if (!ordersData || ordersData.length === 0) {
                container.innerHTML = '<div class="no-data">Nenhum pedido encontrado</div>';
                return;
            }
            
            container.innerHTML = `
                <table class="orders-table">
                    <thead>
                        <tr>
                            <th>Data</th>
                            <th>Pedido</th>
                            <th>Status</th>
                            <th>Valor</th>
                            <th>Taxa Entrega</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${ordersData.slice(0, 50).map(order => {
                            const status = (order.status || '').toLowerCase();
                            const statusClass = status.includes('conclu') || status.includes('delivered') ? 'concluded' : 
                                               status.includes('confirm') ? 'confirmed' : 
                                               status.includes('cancel') ? 'cancelled' : '';
                            const total = order.total?.orderAmount || order.totalPrice || 0;
                            const deliveryFee = order.total?.deliveryFee || 0;
                            
                            return `<tr>
                                <td>${formatDate(order.createdAt)}</td>
                                <td>${order.id?.slice(0, 8) || '-'}...</td>
                                <td><span class="order-status ${statusClass}">${order.status || '-'}</span></td>
                                <td>${formatCurrency(total)}</td>
                                <td>${formatCurrency(deliveryFee)}</td>
                            </tr>`;
                        }).join('')}
                    </tbody>
                </table>
            `;
        }
        
        function renderHourlyChart() {
            const ctx = document.getElementById('hourlyChart').getContext('2d');
            
            if (!chartsData || !chartsData.hourly_chart) {
                document.getElementById('hourlyStats').innerHTML = '<div class="section-metric"><div class="section-metric-label">Sem dados</div></div>';
                return;
            }
            
            const hourlyData = chartsData.hourly_chart;
            const interruptions = chartsData.interruptions || [];
            
            if (hourlyChart) hourlyChart.destroy();
            
            // Prepare datasets
            const datasets = [{
                label: 'Pedidos',
                data: hourlyData.datasets?.[0]?.data || [],
                backgroundColor: 'rgba(34, 197, 94, 0.7)',
                borderColor: '#22c55e',
                borderWidth: 1,
                borderRadius: 4,
                order: 2
            }];
            
            // Custom plugin to draw closure overlay as a single continuous bar
            const closureOverlayPlugin = {
                id: 'closureOverlay',
                beforeDatasetsDraw: (chart) => {
                    if (!interruptions || interruptions.length === 0) return;
                    
                    const ctx = chart.ctx;
                    const chartArea = chart.chartArea;
                    const xScale = chart.scales.x;
                    const yScale = chart.scales.y;
                    
                    interruptions.forEach(interruption => {
                        const startHour = interruption.start_hour;
                        const endHour = interruption.end_hour;
                        
                        // Get pixel positions
                        const startX = xScale.getPixelForValue(startHour);
                        const endX = xScale.getPixelForValue(endHour - 1);
                        
                        // Calculate width to span the full period
                        const barWidth = xScale.getPixelForValue(1) - xScale.getPixelForValue(0);
                        const width = endX - startX + barWidth;
                        
                        // Draw the closure bar
                        ctx.save();
                        ctx.fillStyle = 'rgba(220, 38, 38, 0.35)';
                        ctx.fillRect(
                            startX,
                            chartArea.top,
                            width,
                            chartArea.bottom - chartArea.top
                        );
                        
                        // Add border
                        ctx.strokeStyle = '#dc2626';
                        ctx.lineWidth = 2;
                        ctx.strokeRect(
                            startX,
                            chartArea.top,
                            width,
                            chartArea.bottom - chartArea.top
                        );
                        ctx.restore();
                    });
                }
            };
            
            hourlyChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: hourlyData.labels || [],
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: { 
                            display: interruptions.length > 0,
                            position: 'bottom',
                            labels: {
                                usePointStyle: true,
                                pointStyle: 'circle',
                                padding: 15,
                                font: { size: 11 },
                                boxWidth: 6,
                                boxHeight: 6,
                                filter: function(legendItem) {
                                    // Show legend for closure
                                    return true;
                                },
                                generateLabels: function(chart) {
                                    const original = Chart.defaults.plugins.legend.labels.generateLabels(chart);
                                    if (interruptions.length > 0) {
                                        original.push({
                                            text: 'Restaurante Fechado',
                                            fillStyle: 'rgba(220, 38, 38, 0.35)',
                                            strokeStyle: '#dc2626',
                                            lineWidth: 2,
                                            hidden: false,
                                            index: original.length
                                        });
                                    }
                                    return original;
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    if (context.dataset.label === 'Restaurante Fechado') {
                                        return 'Fechado temporariamente';
                                    }
                                    return context.dataset.label + ': ' + context.parsed.y + ' pedidos';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: document.documentElement.getAttribute('data-theme') === 'dark' ? '#1f1f1f' : '#f1f5f9' }
                        },
                        x: {
                            grid: { display: false },
                            offset: false,
                            ticks: {
                                autoSkip: false
                            }
                        }
                    }
                },
                plugins: [closureOverlayPlugin]
            });
            
            // Calculate hourly stats
            const data = hourlyData.datasets?.[0]?.data || [];
            if (data.length > 0) {
                const peakHour = data.indexOf(Math.max(...data));
                const totalOrders = data.reduce((a, b) => a + b, 0);
                const avgPerHour = totalOrders / 24;
                
                // Get total closed hours from chartsData
                const totalClosedHours = chartsData.total_closed_hours || 0;
                const totalClosedHoursInt = chartsData.total_closed_hours_int || 0;
                const totalClosedMinutesInt = chartsData.total_closed_minutes_int || 0;
                const interruptionCount = chartsData.interruption_count || 0;
                
                // Format closed time display
                let closedTimeDisplay = '0h';
                if (totalClosedHours > 0) {
                    if (totalClosedMinutesInt > 0) {
                        closedTimeDisplay = `${totalClosedHoursInt}h ${totalClosedMinutesInt}min`;
                    } else {
                        closedTimeDisplay = `${totalClosedHoursInt}h`;
                    }
                }
                
                // Add interruption info to stats if present
                let interruptionHtml = '';
                if (interruptions && interruptions.length > 0) {
                    const int = interruptions[0];
                    interruptionHtml = `
                        <div class="section-metric">
                            <div class="section-metric-label">Ãšltimo Fechamento</div>
                            <div class="section-metric-value">${int.start} - ${int.end}</div>
                            <div class="section-metric-trend negative">${int.description}</div>
                        </div>
                    `;
                }
                
                // Total closed hours metric
                let closedHoursHtml = '';
                if (totalClosedHours > 0 || interruptionCount > 0) {
                    closedHoursHtml = `
                        <div class="section-metric">
                            <div class="section-metric-label">Tempo Fechado</div>
                            <div class="section-metric-value">${closedTimeDisplay}</div>
                            <div class="section-metric-trend negative">${interruptionCount} ${interruptionCount === 1 ? 'pausa' : 'pausas'}</div>
                        </div>
                    `;
                }
                
                document.getElementById('hourlyStats').innerHTML = `
                    <div class="section-metric">
                        <div class="section-metric-label">HorÃ¡rio de Pico</div>
                        <div class="section-metric-value">${peakHour}:00</div>
                        <div class="section-metric-trend positive">${data[peakHour]} pedidos</div>
                    </div>
                    <div class="section-metric">
                        <div class="section-metric-label">MÃ©dia por Hora</div>
                        <div class="section-metric-value">${avgPerHour.toFixed(1)}</div>
                        <div class="section-metric-trend">pedidos/hora</div>
                    </div>
                    <div class="section-metric">
                        <div class="section-metric-label">Total no PerÃ­odo</div>
                        <div class="section-metric-value">${totalOrders}</div>
                        <div class="section-metric-trend">pedidos</div>
                    </div>
                    ${closedHoursHtml}
                    ${interruptionHtml}
                `;
            }
        }
        
        // Initialize on page load
        window.addEventListener('DOMContentLoaded', function() {
            console.log('ðŸš€ Page loaded, initializing...');
            console.log('Restaurant ID:', restaurantId);
            
            // Initialize theme from localStorage
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            console.log('Theme set to:', savedTheme);
            
            // Initialize new filter system
            initializeFilterListeners();
            updateFilterLabel();
            
            // Load restaurant data
            loadRestaurantData();
            
            // Set up tab switching (tabs use class="view-tab" and data-view attribute)
            document.querySelectorAll('.view-tab').forEach(btn => {
                btn.addEventListener('click', function() {
                    const view = this.getAttribute('data-view');
                    console.log('Tab clicked:', view);
                    switchTab(view);
                });
            });
            
            // Set up chart tab switching
            document.querySelectorAll('.chart-tab-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const chart = this.dataset.chart;
                    switchChartTab(chart);
                });
            });
            
            console.log('âœ… Initialization complete');
        });
        
    </script>
</body>
</html>