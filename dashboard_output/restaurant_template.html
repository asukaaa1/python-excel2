<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{restaurant_name}} - Dashboard</title>
    <link rel="icon" type="image/png" sizes="32x32" href="/static/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/static/favicon-16x16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/static/apple-touch-icon.png">
    <link rel="manifest" href="/static/site.webmanifest">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        *,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
        :root{--font-display:'Outfit',system-ui,sans-serif;--font-mono:'JetBrains Mono',monospace;--gray-50:#fafafa;--gray-100:#f5f5f5;--gray-200:#e5e5e5;--gray-300:#d4d4d4;--gray-400:#a3a3a3;--gray-500:#737373;--gray-600:#525252;--gray-700:#404040;--gray-800:#262626;--gray-900:#171717;--gray-950:#0a0a0a;--brand-50:#fff5f3;--brand-100:#ffe8e3;--brand-300:#ffb3a3;--brand-500:#f97015;--brand-600:#e6481f;--emerald-50:#ecfdf5;--emerald-500:#10b981;--emerald-600:#059669;--rose-50:#fff1f2;--rose-500:#f43f5e;--rose-600:#e11d48;--amber-50:#fffbeb;--amber-500:#f59e0b;--amber-600:#d97706;--sky-50:#f0f9ff;--sky-500:#0ea5e9;--sky-600:#0284c7;--bg-base:#fff;--bg-subtle:var(--gray-50);--bg-muted:var(--gray-100);--bg-emphasis:var(--gray-200);--text-primary:var(--gray-900);--text-secondary:var(--gray-600);--text-muted:var(--gray-400);--border-subtle:var(--gray-200);--border-default:var(--gray-300);--shadow-xs:0 1px 2px rgba(0,0,0,.04);--shadow-sm:0 1px 3px rgba(0,0,0,.06),0 1px 2px rgba(0,0,0,.04);--shadow-md:0 4px 8px -2px rgba(0,0,0,.08),0 2px 4px -2px rgba(0,0,0,.04);--shadow-lg:0 12px 24px -4px rgba(0,0,0,.1);--shadow-xl:0 24px 48px -12px rgba(0,0,0,.12);--shadow-brand:0 8px 24px -4px rgba(249,112,21,.25);--radius-sm:6px;--radius-md:8px;--radius-lg:12px;--radius-xl:16px;--radius-2xl:20px;--radius-full:9999px;--ease-out:cubic-bezier(.33,1,.68,1);--ease-spring:cubic-bezier(.34,1.56,.64,1)}
        [data-theme="dark"]{--bg-base:var(--gray-950);--bg-subtle:var(--gray-900);--bg-muted:var(--gray-800);--bg-emphasis:var(--gray-700);--text-primary:var(--gray-50);--text-secondary:var(--gray-400);--text-muted:var(--gray-500);--border-subtle:var(--gray-800);--border-default:var(--gray-700);--shadow-xs:0 1px 2px rgba(0,0,0,.2);--shadow-sm:0 1px 3px rgba(0,0,0,.3);--shadow-md:0 4px 8px rgba(0,0,0,.4);--shadow-lg:0 12px 24px rgba(0,0,0,.5);--shadow-xl:0 24px 48px rgba(0,0,0,.6)}
        html{scroll-behavior:smooth}body{font-family:var(--font-display);background:var(--bg-subtle);color:var(--text-primary);line-height:1.5;-webkit-font-smoothing:antialiased;min-height:100vh}
        .app{max-width:1440px;margin:0 auto;padding:24px}@media(max-width:768px){.app{padding:16px}}
        .nav-bar{display:flex;align-items:center;justify-content:space-between;gap:16px;margin-bottom:24px}
        .nav-back{display:inline-flex;align-items:center;gap:8px;padding:10px 16px;background:var(--bg-base);border:1px solid var(--border-subtle);border-radius:var(--radius-lg);color:var(--text-secondary);font-size:14px;font-weight:500;text-decoration:none;transition:all .2s var(--ease-out)}.nav-back:hover{color:var(--text-primary);border-color:var(--border-default);box-shadow:var(--shadow-sm);transform:translateX(-2px)}.nav-back svg{width:18px;height:18px}
        .nav-actions{display:flex;align-items:center;gap:8px}.nav-btn{width:40px;height:40px;display:flex;align-items:center;justify-content:center;background:var(--bg-base);border:1px solid var(--border-subtle);border-radius:var(--radius-lg);color:var(--text-secondary);cursor:pointer;transition:all .2s var(--ease-out)}.nav-btn:hover{color:var(--text-primary);border-color:var(--brand-500);background:var(--brand-50)}[data-theme="dark"] .nav-btn:hover{background:rgba(249,112,21,.1)}.nav-btn svg{width:20px;height:20px}
        .header-card{background:var(--bg-base);border:1px solid var(--border-subtle);border-radius:var(--radius-2xl);padding:24px;margin-bottom:24px;box-shadow:var(--shadow-sm)}.header-top{display:flex;justify-content:space-between;align-items:flex-start;gap:20px;flex-wrap:wrap}.header-main{display:flex;flex-direction:column;gap:12px}.header-title-row{display:flex;align-items:center;gap:12px;flex-wrap:wrap}.restaurant-name{font-size:28px;font-weight:700;letter-spacing:-.02em;color:var(--text-primary)}.super-badge{width:28px;height:28px}.super-badge img{width:100%;height:100%;object-fit:contain}.super-badge--text{height:20px;padding:0 6px;border-radius:999px;background:rgba(249,112,21,.12);color:#f97015;font-size:10px;font-weight:700;line-height:20px;display:inline-flex;align-items:center;justify-content:center}.super-badge--text::before{content:"Super"}
        .rating-pill{display:inline-flex;align-items:center;gap:6px;padding:6px 12px;background:var(--amber-50);border-radius:var(--radius-full);font-size:14px;font-weight:600;color:var(--amber-600)}[data-theme="dark"] .rating-pill{background:rgba(245,158,11,.15);color:var(--amber-500)}.rating-pill svg{width:16px;height:16px;fill:currentColor}
        .header-meta{display:flex;align-items:center;gap:16px;flex-wrap:wrap}.meta-item{display:flex;align-items:center;gap:6px;font-size:14px;color:var(--text-secondary)}.meta-item svg{width:16px;height:16px;color:var(--text-muted)}.platform-badges{display:flex;gap:6px}.platform-badge{padding:4px 10px;background:var(--bg-muted);border-radius:var(--radius-md);font-size:12px;font-weight:500;color:var(--text-secondary)}
        .header-status{display:flex;flex-direction:column;align-items:flex-end;gap:12px}.status-alert{display:none;align-items:center;gap:8px;padding:10px 16px;background:linear-gradient(135deg,var(--rose-500) 0%,var(--rose-600) 100%);border-radius:var(--radius-lg);color:#fff;font-size:13px;font-weight:600;animation:pulse-alert 2s ease-in-out infinite;cursor:pointer}.status-alert.active{display:flex}@keyframes pulse-alert{0%,100%{box-shadow:0 4px 12px rgba(244,63,94,.3)}50%{box-shadow:0 4px 20px rgba(244,63,94,.5)}}.status-alert svg{width:18px;height:18px}
        .api-status{display:flex;align-items:center;gap:8px;padding:8px 12px;background:var(--bg-muted);border-radius:var(--radius-md);font-size:12px;color:var(--text-secondary)}.api-dot{width:8px;height:8px;border-radius:50%;background:var(--emerald-500);box-shadow:0 0 8px var(--emerald-500)}.api-status.loading .api-dot{background:var(--amber-500);box-shadow:0 0 8px var(--amber-500);animation:blink 1s ease-in-out infinite}.api-status.error .api-dot{background:var(--rose-500);box-shadow:0 0 8px var(--rose-500)}@keyframes blink{0%,100%{opacity:1}50%{opacity:.4}}
        .tabs-container{display:flex;align-items:center;justify-content:space-between;gap:16px;margin-bottom:24px;flex-wrap:wrap}.tabs{display:flex;gap:4px;padding:4px;background:var(--bg-base);border:1px solid var(--border-subtle);border-radius:var(--radius-xl)}.tab{padding:10px 20px;background:transparent;border:none;border-radius:var(--radius-lg);font-family:var(--font-display);font-size:14px;font-weight:500;color:var(--text-secondary);cursor:pointer;transition:all .2s var(--ease-out)}.tab:hover{color:var(--text-primary);background:var(--bg-muted)}.tab.active{background:var(--brand-500);color:#fff;box-shadow:var(--shadow-brand)}
        .filter-bar{display:flex;align-items:center;gap:12px;padding:12px 16px;background:var(--bg-base);border:1px solid var(--border-subtle);border-radius:var(--radius-xl);box-shadow:var(--shadow-xs);flex-wrap:wrap}.filter-info{display:flex;align-items:center;gap:10px;flex:1}.filter-icon{width:36px;height:36px;display:flex;align-items:center;justify-content:center;background:var(--brand-50);border-radius:var(--radius-md);color:var(--brand-500)}[data-theme="dark"] .filter-icon{background:rgba(249,112,21,.15)}.filter-icon svg{width:18px;height:18px}.filter-text{display:flex;flex-direction:column;gap:2px}.filter-label{font-size:12px;color:var(--text-muted);text-transform:uppercase;letter-spacing:.05em}.filter-value{font-size:14px;font-weight:600;color:var(--text-primary)}
        .filter-btn{display:flex;align-items:center;gap:8px;padding:10px 18px;background:var(--brand-500);border:none;border-radius:var(--radius-lg);color:#fff;font-family:var(--font-display);font-size:14px;font-weight:600;cursor:pointer;transition:all .2s var(--ease-out);box-shadow:var(--shadow-brand)}.filter-btn:hover{background:var(--brand-600);transform:translateY(-1px)}.filter-btn svg{width:18px;height:18px}
                                .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);backdrop-filter:blur(4px);display:flex;align-items:center;justify-content:center;z-index:1000;opacity:0;visibility:hidden;transition:all .3s var(--ease-out);padding:20px}.modal-overlay.active{opacity:1;visibility:visible}.modal{background:var(--bg-base);border:1px solid var(--border-subtle);border-radius:var(--radius-2xl);width:100%;max-width:480px;max-height:90vh;overflow:hidden;box-shadow:var(--shadow-xl);transform:translateY(20px) scale(.98);transition:transform .3s var(--ease-spring)}.modal-overlay.active .modal{transform:translateY(0) scale(1)}.modal-header{display:flex;align-items:center;justify-content:space-between;padding:20px 24px;border-bottom:1px solid var(--border-subtle)}.modal-title{font-size:18px;font-weight:700;color:var(--text-primary)}.modal-close{width:36px;height:36px;display:flex;align-items:center;justify-content:center;background:var(--bg-muted);border:none;border-radius:var(--radius-md);color:var(--text-secondary);cursor:pointer;transition:all .2s var(--ease-out)}.modal-close:hover{background:var(--bg-emphasis);color:var(--text-primary);transform:rotate(90deg)}.modal-close svg{width:18px;height:18px}.modal-body{padding:24px;max-height:calc(90vh - 160px);overflow-y:auto}.modal-footer{display:flex;gap:12px;padding:20px 24px;border-top:1px solid var(--border-subtle)}
        .filter-section{margin-bottom:24px}.filter-section:last-child{margin-bottom:0}.filter-section-title{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.1em;color:var(--text-muted);margin-bottom:12px}.filter-type-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}.filter-type-option{position:relative}.filter-type-option input{position:absolute;opacity:0;pointer-events:none}.filter-type-option label{display:flex;flex-direction:column;align-items:center;gap:8px;padding:16px 12px;background:var(--bg-subtle);border:2px solid transparent;border-radius:var(--radius-lg);font-size:13px;font-weight:500;color:var(--text-secondary);cursor:pointer;transition:all .2s var(--ease-out)}.filter-type-option label:hover{background:var(--bg-muted);border-color:var(--border-default)}.filter-type-option input:checked+label{background:var(--brand-50);border-color:var(--brand-500);color:var(--brand-600)}[data-theme="dark"] .filter-type-option input:checked+label{background:rgba(249,112,21,.1);color:var(--brand-300)}.filter-type-option label svg{width:24px;height:24px;opacity:.6}.filter-type-option input:checked+label svg{opacity:1;color:var(--brand-500)}
        .filter-quick-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}.filter-quick-btn{padding:14px 12px;background:var(--bg-subtle);border:2px solid transparent;border-radius:var(--radius-lg);font-family:var(--font-display);font-size:13px;font-weight:600;color:var(--text-secondary);cursor:pointer;transition:all .2s var(--ease-out)}.filter-quick-btn:hover{background:var(--bg-muted);border-color:var(--border-default)}.filter-quick-btn.active{background:var(--brand-500);border-color:var(--brand-500);color:#fff;box-shadow:var(--shadow-brand)}
        .filter-months-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}.filter-month-btn{padding:12px;background:var(--bg-subtle);border:2px solid transparent;border-radius:var(--radius-lg);font-family:var(--font-display);font-size:12px;font-weight:600;color:var(--text-secondary);cursor:pointer;transition:all .2s var(--ease-out)}.filter-month-btn:hover{background:var(--bg-muted);border-color:var(--border-default)}.filter-month-btn.active{background:var(--brand-500);border-color:var(--brand-500);color:#fff}
        .filter-date-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}.filter-date-group label{display:block;font-size:12px;font-weight:500;color:var(--text-secondary);margin-bottom:6px}.filter-date-input{width:100%;padding:12px 14px;background:var(--bg-subtle);border:2px solid var(--border-subtle);border-radius:var(--radius-lg);font-family:var(--font-display);font-size:14px;color:var(--text-primary);transition:all .2s var(--ease-out)}.filter-date-input:focus{outline:none;border-color:var(--brand-500);box-shadow:0 0 0 3px rgba(249,112,21,.15)}
        .filter-content{display:none}.filter-content.active{display:block;animation:fadeIn .2s var(--ease-out)}@keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
        .btn-cancel{flex:1;padding:12px 20px;background:var(--bg-subtle);border:1px solid var(--border-default);border-radius:var(--radius-lg);font-family:var(--font-display);font-size:14px;font-weight:600;color:var(--text-secondary);cursor:pointer;transition:all .2s var(--ease-out)}.btn-cancel:hover{background:var(--bg-muted);color:var(--text-primary)}.btn-apply{flex:1;padding:12px 20px;background:var(--brand-500);border:none;border-radius:var(--radius-lg);font-family:var(--font-display);font-size:14px;font-weight:600;color:#fff;cursor:pointer;transition:all .2s var(--ease-out);box-shadow:var(--shadow-brand)}.btn-apply:hover{background:var(--brand-600);transform:translateY(-1px)}
        .view-container{display:none}.view-container.active{display:block;animation:fadeIn .3s var(--ease-out)}
        .kpi-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:16px;margin-bottom:24px}.kpi-card{background:var(--bg-base);border:1px solid var(--border-subtle);border-radius:var(--radius-xl);padding:20px;transition:all .2s var(--ease-out)}.kpi-card:hover{border-color:var(--brand-300);box-shadow:var(--shadow-md);transform:translateY(-2px)}.kpi-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}.kpi-label{font-size:12px;font-weight:600;text-transform:uppercase;letter-spacing:.05em;color:var(--text-muted)}.kpi-icon{width:32px;height:32px;display:flex;align-items:center;justify-content:center;background:var(--bg-muted);border-radius:var(--radius-md);color:var(--text-secondary)}.kpi-icon svg{width:18px;height:18px}.kpi-value{font-size:28px;font-weight:700;letter-spacing:-.02em;color:var(--text-primary);margin-bottom:8px;font-variant-numeric:tabular-nums}.kpi-trend{display:inline-flex;align-items:center;gap:4px;padding:4px 8px;border-radius:var(--radius-md);font-size:12px;font-weight:600}.kpi-trend.positive{background:var(--emerald-50);color:var(--emerald-600)}.kpi-trend.negative{background:var(--rose-50);color:var(--rose-600)}[data-theme="dark"] .kpi-trend.positive{background:rgba(16,185,129,.15);color:var(--emerald-500)}[data-theme="dark"] .kpi-trend.negative{background:rgba(244,63,94,.15);color:var(--rose-500)}.kpi-trend svg{width:14px;height:14px}
        .metrics-section{background:var(--bg-base);border:1px solid var(--border-subtle);border-radius:var(--radius-xl);margin-bottom:24px;overflow:hidden}.metrics-header{display:flex;align-items:center;gap:10px;padding:16px 20px;border-bottom:1px solid var(--border-subtle)}.metrics-header svg{width:20px;height:20px;color:var(--brand-500)}.metrics-header h3{font-size:15px;font-weight:600;color:var(--text-primary)}.metrics-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr))}.metric-cell{padding:16px 20px;text-align:center;border-right:1px solid var(--border-subtle);border-bottom:1px solid var(--border-subtle)}.metric-cell:last-child{border-right:none}.metric-label{font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.05em;color:var(--text-muted);margin-bottom:6px}.metric-value{font-size:18px;font-weight:700;color:var(--text-primary);font-variant-numeric:tabular-nums;margin-bottom:4px}.metric-trend{font-size:12px;font-weight:600}.metric-trend.positive{color:var(--emerald-500)}.metric-trend.negative{color:var(--rose-500)}
        .chart-section{background:var(--bg-base);border:1px solid var(--border-subtle);border-radius:var(--radius-xl);margin-bottom:24px;overflow:hidden}.chart-header{display:flex;align-items:center;justify-content:space-between;gap:16px;padding:16px 20px;border-bottom:1px solid var(--border-subtle);flex-wrap:wrap}.chart-title{font-size:16px;font-weight:600;color:var(--text-primary)}.chart-controls{display:flex;align-items:center;gap:12px;flex-wrap:wrap}.chart-tabs{display:flex;gap:4px;padding:3px;background:var(--bg-muted);border-radius:var(--radius-md)}.chart-tab{padding:6px 12px;background:transparent;border:none;border-radius:var(--radius-sm);font-family:var(--font-display);font-size:12px;font-weight:500;color:var(--text-secondary);cursor:pointer;transition:all .2s var(--ease-out)}.chart-tab:hover{color:var(--text-primary)}.chart-tab.active{background:var(--bg-base);color:var(--text-primary);box-shadow:var(--shadow-xs)}.chart-select{padding:8px 32px 8px 12px;background:var(--bg-subtle);border:1px solid var(--border-subtle);border-radius:var(--radius-md);font-family:var(--font-display);font-size:13px;font-weight:500;color:var(--text-primary);cursor:pointer;appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23737373' stroke-width='2'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 8px center;transition:all .2s var(--ease-out)}.chart-select:hover{border-color:var(--border-default)}.chart-select:focus{outline:none;border-color:var(--brand-500)}.chart-container{padding:20px}.chart-wrapper{position:relative;height:320px}.chart-stats{display:flex;gap:32px;padding:16px 20px;background:var(--bg-subtle);border-top:1px solid var(--border-subtle);flex-wrap:wrap}.chart-stat{font-size:13px;color:var(--text-secondary)}.chart-stat strong{color:var(--text-primary);font-weight:600}
        .data-section{background:var(--bg-base);border:1px solid var(--border-subtle);border-radius:var(--radius-xl);margin-bottom:24px;overflow:hidden}.data-header{padding:16px 20px;background:var(--bg-subtle);border-bottom:1px solid var(--border-subtle)}.data-header h3{font-size:16px;font-weight:600;color:var(--text-primary)}.table-wrapper{overflow-x:auto}.data-table{width:100%;border-collapse:collapse}.data-table th{padding:14px 20px;text-align:left;font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.05em;color:var(--text-muted);background:var(--bg-subtle);border-bottom:1px solid var(--border-subtle);white-space:nowrap}.data-table td{padding:14px 20px;font-size:14px;color:var(--text-primary);border-bottom:1px solid var(--border-subtle);vertical-align:middle}.data-table tbody tr{transition:background .15s var(--ease-out)}.data-table tbody tr:hover{background:var(--bg-subtle)}.data-table tbody tr:last-child td{border-bottom:none}.order-id{font-family:var(--font-mono);font-size:13px;color:var(--text-secondary)}.status-badge{display:inline-flex;align-items:center;padding:5px 10px;border-radius:var(--radius-full);font-size:12px;font-weight:600;text-transform:uppercase;letter-spacing:.02em}.status-badge.concluded{background:var(--emerald-50);color:var(--emerald-600)}.status-badge.confirmed{background:var(--sky-50);color:var(--sky-600)}.status-badge.cancelled{background:var(--rose-50);color:var(--rose-600)}[data-theme="dark"] .status-badge.concluded{background:rgba(16,185,129,.15);color:var(--emerald-500)}[data-theme="dark"] .status-badge.confirmed{background:rgba(14,165,233,.15);color:var(--sky-500)}[data-theme="dark"] .status-badge.cancelled{background:rgba(244,63,94,.15);color:var(--rose-500)}.empty-state{padding:60px 20px;text-align:center;color:var(--text-muted)}.empty-state svg{width:48px;height:48px;margin-bottom:12px;opacity:.5}
        .feedback-section{background:var(--bg-base);border:1px solid var(--border-subtle);border-radius:var(--radius-xl);padding:24px}.feedback-header{display:flex;align-items:center;gap:12px;margin-bottom:24px;padding-bottom:16px;border-bottom:1px solid var(--border-subtle)}.feedback-header-icon{width:44px;height:44px;display:flex;align-items:center;justify-content:center;background:var(--brand-50);border-radius:var(--radius-lg);color:var(--brand-500)}[data-theme="dark"] .feedback-header-icon{background:rgba(249,112,21,.15)}.feedback-header-icon svg{width:24px;height:24px}.feedback-header h2{font-size:20px;font-weight:700;color:var(--text-primary)}.feedback-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(340px,1fr));gap:20px}.feedback-card{background:var(--bg-subtle);border:1px solid var(--border-subtle);border-radius:var(--radius-xl);padding:20px}.feedback-card-header{display:flex;align-items:center;gap:12px;margin-bottom:20px}.feedback-card-icon{width:40px;height:40px;display:flex;align-items:center;justify-content:center;border-radius:var(--radius-lg);color:#fff}.feedback-card-icon.compliments{background:var(--emerald-500)}.feedback-card-icon.complaints{background:var(--rose-500)}.feedback-card-icon.cancellations{background:var(--amber-500)}.feedback-card-icon.origins{background:var(--sky-500)}.feedback-card-icon svg{width:20px;height:20px}.feedback-card-header h3{font-size:15px;font-weight:600;color:var(--text-primary)}.feedback-chart-wrapper{position:relative;height:220px}
        .reviews-overview{display:grid;grid-template-columns:auto 1fr;gap:32px;align-items:center;padding:24px;background:var(--bg-base);border:1px solid var(--border-subtle);border-radius:var(--radius-xl);margin-bottom:24px}
        .reviews-score{text-align:center;min-width:140px}.reviews-score-value{font-size:56px;font-weight:800;letter-spacing:-.03em;color:var(--text-primary);line-height:1}.reviews-score-stars{display:flex;justify-content:center;gap:2px;margin:8px 0}.reviews-score-stars svg{width:20px;height:20px}.star-filled{color:var(--amber-500)}.star-empty{color:var(--border-default)}.reviews-score-count{font-size:13px;color:var(--text-muted);font-weight:500}
        .reviews-bars{display:flex;flex-direction:column;gap:8px}.reviews-bar-row{display:flex;align-items:center;gap:10px;font-size:13px;font-weight:500}.reviews-bar-label{min-width:24px;text-align:right;color:var(--text-secondary)}.reviews-bar-track{flex:1;height:10px;background:var(--bg-emphasis);border-radius:var(--radius-full);overflow:hidden}.reviews-bar-fill{height:100%;border-radius:var(--radius-full);background:var(--amber-500);transition:width .6s var(--ease-out)}.reviews-bar-count{min-width:32px;font-family:var(--font-mono);font-size:12px;color:var(--text-muted)}
        .reviews-trend{background:var(--bg-base);border:1px solid var(--border-subtle);border-radius:var(--radius-xl);margin-bottom:24px;overflow:hidden}.reviews-trend-header{display:flex;align-items:center;gap:10px;padding:16px 20px;border-bottom:1px solid var(--border-subtle)}.reviews-trend-header svg{width:20px;height:20px;color:var(--amber-500)}.reviews-trend-header h3{font-size:15px;font-weight:600;color:var(--text-primary)}.reviews-trend-chart{padding:20px}.reviews-trend-wrapper{position:relative;height:200px}
        .reviews-filters{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:20px}.reviews-filter-btn{padding:8px 16px;background:var(--bg-subtle);border:1.5px solid var(--border-subtle);border-radius:var(--radius-full);font-family:var(--font-display);font-size:13px;font-weight:600;color:var(--text-secondary);cursor:pointer;transition:all .2s var(--ease-out)}.reviews-filter-btn:hover{border-color:var(--border-default);color:var(--text-primary)}.reviews-filter-btn.active{background:var(--amber-50);border-color:var(--amber-500);color:var(--amber-600)}[data-theme="dark"] .reviews-filter-btn.active{background:rgba(245,158,11,.12);color:var(--amber-500)}
        .reviews-list{display:flex;flex-direction:column;gap:12px;margin-bottom:20px}.review-card{background:var(--bg-subtle);border:1px solid var(--border-subtle);border-radius:var(--radius-xl);padding:20px;transition:border-color .2s var(--ease-out)}.review-card:hover{border-color:var(--border-default)}.review-card-top{display:flex;justify-content:space-between;align-items:flex-start;gap:12px;margin-bottom:10px;flex-wrap:wrap}.review-customer{display:flex;align-items:center;gap:10px}.review-avatar{width:36px;height:36px;border-radius:var(--radius-full);background:var(--bg-emphasis);display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:700;color:var(--text-secondary)}.review-customer-info{display:flex;flex-direction:column;gap:2px}.review-customer-name{font-size:14px;font-weight:600;color:var(--text-primary)}.review-date{font-size:12px;color:var(--text-muted)}.review-stars{display:flex;gap:2px}.review-stars svg{width:16px;height:16px}.review-comment{font-size:14px;line-height:1.6;color:var(--text-secondary);margin-bottom:12px}.review-tags{display:flex;flex-wrap:wrap;gap:6px}.review-tag{padding:4px 10px;border-radius:var(--radius-full);font-size:11px;font-weight:600}.review-tag.positive{background:var(--emerald-50);color:var(--emerald-600)}[data-theme="dark"] .review-tag.positive{background:rgba(16,185,129,.15);color:var(--emerald-500)}.review-tag.negative{background:var(--rose-50);color:var(--rose-600)}[data-theme="dark"] .review-tag.negative{background:rgba(244,63,94,.15);color:var(--rose-500)}.review-order-id{font-family:var(--font-mono);font-size:11px;color:var(--text-muted);margin-top:8px}
        .reviews-load-more{width:100%;padding:12px;background:var(--bg-subtle);border:1.5px solid var(--border-subtle);border-radius:var(--radius-lg);font-family:var(--font-display);font-size:14px;font-weight:600;color:var(--text-secondary);cursor:pointer;transition:all .2s var(--ease-out);margin-bottom:24px}.reviews-load-more:hover{border-color:var(--border-default);color:var(--text-primary);background:var(--bg-muted)}
        @media(max-width:768px){.reviews-overview{grid-template-columns:1fr;text-align:center}.reviews-score{min-width:auto}}
        .toast{position:fixed;bottom:24px;right:24px;background:var(--bg-base);border:1px solid var(--border-subtle);padding:12px 16px;border-radius:var(--radius-lg);box-shadow:var(--shadow-lg);display:flex;align-items:center;gap:8px;font-size:13px;color:var(--text-primary);z-index:2000}
        @media(max-width:1024px){.feedback-grid{grid-template-columns:1fr}}@media(max-width:768px){.header-top{flex-direction:column;align-items:flex-start}.header-status{align-items:flex-start;width:100%}.tabs-container{flex-direction:column;align-items:stretch}.tabs{width:100%;overflow-x:auto}.filter-bar{flex-direction:column;align-items:stretch}.filter-btn{width:100%;justify-content:center}.kpi-grid{grid-template-columns:repeat(2,1fr)}.chart-wrapper{height:250px}.filter-type-grid,.filter-quick-grid,.filter-months-grid{grid-template-columns:1fr}}@media(max-width:480px){.kpi-grid{grid-template-columns:1fr}.restaurant-name{font-size:22px}}
        @media print{
            html,body{background:#fff!important}
            .app{max-width:none!important;padding:0!important}
            .nav-bar,.tabs-container,.modal-overlay,.toast,.reviews-load-more{display:none!important}
            .view-container{display:none!important}
            .view-container.active{display:block!important}
            .kpi-card,.metrics-section,.chart-section,.data-section,.header-card,.reviews-overview,.reviews-trend,.feedback-section{box-shadow:none!important;break-inside:avoid;page-break-inside:avoid}
            .chart-wrapper,.reviews-trend-wrapper{height:220px!important}
            .table-wrapper{overflow:visible!important}
        }
    </style>
</head>
<body>
    <div class="app">
        <nav class="nav-bar"><a href="/dashboard" class="nav-back"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>Voltar para Clientes</a><div class="nav-actions"><button class="nav-btn" onclick="refreshData()" title="Atualizar"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg></button><button class="nav-btn" id="exportPdfBtn" onclick="exportDashboardPdf()" title="Exportar PDF"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 16v-8m0 8l-3-3m3 3l3-3M9 4h6a2 2 0 012 2v2m-2 12H9a2 2 0 01-2-2V8m10 0H7"/></svg></button><button class="nav-btn" id="themeToggle" onclick="toggleTheme()" title="Tema"><svg id="sunIcon" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="display:none"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"/></svg><svg id="moonIcon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/></svg></button></div></nav>
        <header class="header-card"><div class="header-top"><div class="header-main"><div class="header-title-row"><h1 class="restaurant-name" id="restaurantName">{{restaurant_name}}</h1><span class="super-badge" id="restaurantSuper" style="display:none" title="iFood Super"><img src="/static/selo_ifood_super.png" alt="Super" loading="lazy" decoding="async" onerror="this.closest('.super-badge').classList.add('super-badge--text'); this.remove();"></span><span class="rating-pill" id="restaurantRating" style="display:none"><svg viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg><span id="ratingValue">0.0</span></span></div><div class="header-meta"><span class="meta-item"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg><span id="restaurantManager">{{restaurant_manager}}</span></span><div class="platform-badges" id="platforms"><span class="platform-badge">iFood</span></div></div></div><div class="header-status"><div class="status-alert" id="interruptionBanner"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg><span id="interruptionText">Loja Fechada</span></div><div class="api-status" id="apiStatus"><span class="api-dot"></span><span>Conectando...</span></div></div></div></header>
        <div class="tabs-container"><div class="tabs"><button class="tab active" data-view="dashboard">Dashboard</button><button class="tab" data-view="orders">Pedidos</button><button class="tab" data-view="hourly">Por Hora</button><button class="tab" data-view="feedback">Feedback</button></div><div class="filter-bar"><div class="filter-info"><div class="filter-icon"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg></div><div class="filter-text"><span class="filter-label">Período</span><span class="filter-value" id="filterPeriodLabel">Últimos 7 dias</span></div></div><button class="filter-btn" onclick="openFilterModal()"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"/></svg>Filtrar</button></div></div>
        <div class="modal-overlay" id="filterModal"><div class="modal"><div class="modal-header"><h2 class="modal-title">Filtrar por Período</h2><button class="modal-close" onclick="closeFilterModal()"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg></button></div><div class="modal-body"><div class="filter-section"><div class="filter-section-title">Tipo de Filtro</div><div class="filter-type-grid"><div class="filter-type-option"><input type="radio" name="filterType" id="filterTypeCurrent" value="current" checked><label for="filterTypeCurrent"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>Corrente</label></div><div class="filter-type-option"><input type="radio" name="filterType" id="filterTypeMonth" value="month"><label for="filterTypeMonth"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>Mês</label></div><div class="filter-type-option"><input type="radio" name="filterType" id="filterTypeCustom" value="custom"><label for="filterTypeCustom"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>Personalizado</label></div></div></div><div class="filter-content active" id="filterContentCurrent"><div class="filter-section"><div class="filter-section-title">Selecione o Período</div><div class="filter-quick-grid"><button class="filter-quick-btn active" data-period="7days">7 dias</button><button class="filter-quick-btn" data-period="15days">15 dias</button><button class="filter-quick-btn" data-period="30days">30 dias</button></div></div></div><div class="filter-content" id="filterContentMonth"><div class="filter-section"><div class="filter-section-title">Selecione o Mês</div><div class="filter-months-grid" id="filterMonthsGrid"></div></div></div><div class="filter-content" id="filterContentCustom"><div class="filter-section"><div class="filter-section-title">Intervalo Personalizado</div><div class="filter-date-row"><div class="filter-date-group"><label for="filterDateStart">Data Inicial</label><input type="date" class="filter-date-input" id="filterDateStart"></div><div class="filter-date-group"><label for="filterDateEnd">Data Final</label><input type="date" class="filter-date-input" id="filterDateEnd"></div></div></div></div></div><div class="modal-footer"><button class="btn-cancel" onclick="closeFilterModal()">Cancelar</button><button class="btn-apply" onclick="applyFilter()">Aplicar</button></div></div></div>
        <div class="view-container active" id="dashboardView"><div class="kpi-grid"><div class="kpi-card"><div class="kpi-header"><span class="kpi-label">Faturamento</span><div class="kpi-icon"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg></div></div><div class="kpi-value" id="kpiRevenue">R$ 0,00</div><span class="kpi-trend positive" id="kpiRevenueTrend"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/></svg>+0%</span></div><div class="kpi-card"><div class="kpi-header"><span class="kpi-label">Pedidos</span><div class="kpi-icon"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/></svg></div></div><div class="kpi-value" id="kpiOrders">0</div><span class="kpi-trend positive" id="kpiOrdersTrend"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/></svg>+0%</span></div><div class="kpi-card"><div class="kpi-header"><span class="kpi-label">Cancelamento</span><div class="kpi-icon"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"/></svg></div></div><div class="kpi-value" id="kpiCancellation">0%</div><span class="kpi-trend negative" id="kpiCancellationTrend"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 17h8m0 0V9m0 8l-8-8-4 4-6-6"/></svg>-0%</span></div></div><section class="metrics-section"><div class="metrics-header"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg><h3>Métricas de Faturamento</h3></div><div class="metrics-grid"><div class="metric-cell"><div class="metric-label">Venda Bruta</div><div class="metric-value" id="metricGross">R$ 0</div><div class="metric-trend positive" id="metricGrossTrend">+0%</div></div><div class="metric-cell"><div class="metric-label">Descontos</div><div class="metric-value" id="metricDiscount">R$ 0</div><div class="metric-trend" id="metricDiscountTrend">0%</div></div><div class="metric-cell"><div class="metric-label">Taxa Entrega</div><div class="metric-value" id="metricDelivery">R$ 0</div><div class="metric-trend" id="metricDeliveryTrend">0%</div></div><div class="metric-cell"><div class="metric-label">Comissão</div><div class="metric-value" id="metricCommission">R$ 0</div><div class="metric-trend" id="metricCommissionTrend">0%</div></div><div class="metric-cell"><div class="metric-label">Repasse</div><div class="metric-value" id="metricNet">R$ 0</div><div class="metric-trend positive" id="metricNetTrend">+0%</div></div></div></section><section class="metrics-section"><div class="metrics-header"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/></svg><h3>Métricas de Pedidos</h3></div><div class="metrics-grid"><div class="metric-cell"><div class="metric-label">Concluídos</div><div class="metric-value" id="metricCompleted">0</div><div class="metric-trend positive" id="metricCompletedTrend">+0%</div></div><div class="metric-cell"><div class="metric-label">Cancelados</div><div class="metric-value" id="metricCancelled">0</div><div class="metric-trend" id="metricCancelledTrend">0%</div></div><div class="metric-cell"><div class="metric-label">Itens</div><div class="metric-value" id="metricItems">0</div><div class="metric-trend" id="metricItemsTrend">0%</div></div><div class="metric-cell"><div class="metric-label">Dias Ativos</div><div class="metric-value" id="metricDays">0</div><div class="metric-trend" id="metricDaysTrend">-</div></div></div></section><section class="chart-section"><div class="chart-header"><h3 class="chart-title">Evolução de Vendas <span id="forecastBadge" style="display:none;align-items:center;gap:4px;font-size:11px;font-weight:500;color:rgba(249,112,21,0.7);border:1.5px dashed rgba(249,112,21,0.4);border-radius:6px;padding:2px 8px;margin-left:8px;vertical-align:middle;">Previsão 7d</span></h3><div class="chart-controls"><div class="chart-tabs"><button class="chart-tab active" data-chart="revenue">Faturamento</button><button class="chart-tab" data-chart="orders">Pedidos</button></div><select class="chart-select" id="chartGroupBy"><option value="day">Por Dia</option><option value="week">Por Semana</option></select></div></div><div class="chart-container"><div class="chart-wrapper"><canvas id="mainChart"></canvas></div></div><div class="chart-stats"><div class="chart-stat">Média: <strong id="chartAvg">R$ 0</strong></div><div class="chart-stat">Maior: <strong id="chartMax">R$ 0</strong></div><div class="chart-stat">Menor: <strong id="chartMin">R$ 0</strong></div></div></section></div>
        <div class="view-container" id="ordersView"><section class="data-section"><div class="data-header"><h3>Lista de Pedidos</h3></div><div class="table-wrapper"><table class="data-table"><thead><tr><th>ID</th><th>Data/Hora</th><th>Valor</th><th>Status</th><th>Pagamento</th></tr></thead><tbody id="ordersTableBody"><tr><td colspan="5" class="empty-state"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/></svg><p>Carregando...</p></td></tr></tbody></table></div></section></div>
        <div class="view-container" id="hourlyView"><section class="chart-section"><div class="chart-header"><h3 class="chart-title">Distribuição por Hora</h3><div class="chart-controls"><div class="chart-tabs"><button class="chart-tab active" data-hourly="revenue">Faturamento</button><button class="chart-tab" data-hourly="orders">Pedidos</button></div></div></div><div class="chart-container"><div class="chart-wrapper"><canvas id="hourlyChart"></canvas></div></div><div class="chart-stats"><div class="chart-stat">Pico: <strong id="hourlyPeak">--</strong></div><div class="chart-stat">Maior: <strong id="hourlyMax">R$ 0</strong></div></div></section></div>
        <div class="view-container" id="feedbackView">
            <!-- Rating Overview -->
            <div class="reviews-overview" id="reviewsOverview">
                <div class="reviews-score">
                    <div class="reviews-score-value" id="reviewsAvgRating">-</div>
                    <div class="reviews-score-stars" id="reviewsStars"></div>
                    <div class="reviews-score-count" id="reviewsTotalCount">0 avaliações</div>
                </div>
                <div class="reviews-bars" id="reviewsBars"></div>
            </div>

            <!-- Rating Trend -->
            <div class="reviews-trend">
                <div class="reviews-trend-header">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/></svg>
                    <h3>Tendência de Avaliações</h3>
                </div>
                <div class="reviews-trend-chart">
                    <div class="reviews-trend-wrapper"><canvas id="ratingTrendChart"></canvas></div>
                </div>
            </div>

            <!-- Reviews Filter + List -->
            <section class="feedback-section">
                <div class="feedback-header">
                    <div class="feedback-header-icon"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"/></svg></div>
                    <h2>Avaliações dos Clientes</h2>
                </div>
                <div class="reviews-filters" id="reviewsFilters">
                    <button class="reviews-filter-btn active" data-filter="all">Todas</button>
                    <button class="reviews-filter-btn" data-filter="5">5★</button>
                    <button class="reviews-filter-btn" data-filter="4">4★</button>
                    <button class="reviews-filter-btn" data-filter="3">3★</button>
                    <button class="reviews-filter-btn" data-filter="2">2★</button>
                    <button class="reviews-filter-btn" data-filter="1">1★</button>
                </div>
                <div class="reviews-list" id="reviewsList">
                    <div class="empty-state"><p>Carregando avaliações...</p></div>
                </div>
                <button class="reviews-load-more" id="reviewsLoadMore" style="display:none" onclick="loadMoreReviews()">Carregar mais avaliações</button>
            </section>

            <!-- Existing Feedback Charts -->
            <section class="feedback-section" style="margin-top:24px">
                <div class="feedback-header">
                    <div class="feedback-header-icon"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg></div>
                    <h2>Análise de Feedback</h2>
                </div>
                <div class="feedback-grid">
                    <div class="feedback-card"><div class="feedback-card-header"><div class="feedback-card-icon compliments"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 10h4.764a2 2 0 011.789 2.894l-3.5 7A2 2 0 0115.263 21h-4.017c-.163 0-.326-.02-.485-.06L7 20m7-10V5a2 2 0 00-2-2h-.095c-.5 0-.905.405-.905.905 0 .714-.211 1.412-.608 2.006L7 11v9m7-10h-2M7 20H5a2 2 0 01-2-2v-6a2 2 0 012-2h2.5"/></svg></div><h3>Elogios</h3></div><div class="feedback-chart-wrapper"><canvas id="complimentsChart"></canvas></div></div>
                    <div class="feedback-card"><div class="feedback-card-header"><div class="feedback-card-icon complaints"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14H5.236a2 2 0 01-1.789-2.894l3.5-7A2 2 0 018.736 3h4.018a2 2 0 01.485.06l3.76.94m-7 10v5a2 2 0 002 2h.096c.5 0 .905-.405.905-.904 0-.715.211-1.413.608-2.008L17 13V4m-7 10h2"/></svg></div><h3>Reclamações</h3></div><div class="feedback-chart-wrapper"><canvas id="complaintsChart"></canvas></div></div>
                    <div class="feedback-card"><div class="feedback-card-header"><div class="feedback-card-icon cancellations"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg></div><h3>Motivos Cancelamento</h3></div><div class="feedback-chart-wrapper"><canvas id="cancellationReasonsChart"></canvas></div></div>
                    <div class="feedback-card"><div class="feedback-card-header"><div class="feedback-card-icon origins"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg></div><h3>Origem Cancelamentos</h3></div><div class="feedback-chart-wrapper"><canvas id="cancellationOriginsChart"></canvas></div></div>
                </div>
            </section>
        </div>
    </div>
    <script>
// Global 401 interceptor
const _origFetch = window.fetch;
window.fetch = async function(...args) {
    const response = await _origFetch.apply(this, args);
    if (response.status === 401 && !String(args[0]).includes('/api/login')) {
        window.location.href = '/login';
    }
    return response;
};

// Restaurant ID from backend
const restaurantId = '{{restaurant_id}}';

// State
let restaurantData = null;
let chartsData = null;
let ordersData = [];
let interruptionsData = [];
let menuPerformanceData = null;
let mainChart = null;
let hourlyChart = null;
let activeChartType = 'revenue';
let activeHourlyType = 'revenue';
let currentFilter = { type: 'current', period: '7days', month: null, startDate: null, endDate: null };
const feedbackCharts = { compliments: null, complaints: null, cancellationReasons: null, cancellationOrigins: null };
let reviewsData = null;
let ratingTrendChart = null;
let reviewsFilter = 'all';
let reviewsPage = 0;
const REVIEWS_PER_PAGE = 10;

// API Functions
async function fetchRestaurantData() {
    const apiStatus = document.getElementById('apiStatus');
    apiStatus.classList.add('loading');
    apiStatus.querySelector('span:last-child').textContent = 'Carregando...';
    
    try {
        const { startDate, endDate } = getFilterDateRange();
        const params = new URLSearchParams();
        if (startDate) params.append('start_date', startDate.toISOString().split('T')[0]);
        if (endDate) params.append('end_date', endDate.toISOString().split('T')[0]);
        
        const response = await fetch(`/api/restaurant/${restaurantId}?${params}`);
        if (response.status === 401) { window.location.href = '/login'; return; }
        const data = await response.json();
        
        if (data.success) {
            restaurantData = data.restaurant;
            interruptionsData = data.interruptions || [];
            menuPerformanceData = data.menu_performance || null;
            reviewsData = data.reviews || null;
            
            // Transform backend chart structure into frontend format
            // Backend: {revenue_chart: {labels, datasets, dates}, orders_chart: {...}, hourly_chart: {...}}
            // Frontend expects: {daily: [{date, revenue, orders, ticket}], hourly: [{hour, revenue, orders}]}
            const rawCharts = data.charts || {};
            chartsData = {};
            
            // Build daily array from revenue_chart + orders_chart
            const revenueChart = rawCharts.revenue_chart || {};
            const ordersChart = rawCharts.orders_chart || {};
            const revLabels = revenueChart.labels || [];
            const revData = (revenueChart.datasets && revenueChart.datasets[0] && revenueChart.datasets[0].data) || [];
            const ordData = (ordersChart.datasets && ordersChart.datasets[0] && ordersChart.datasets[0].data) || [];
            const revDates = revenueChart.dates || [];
            
            if (revLabels.length > 0) {
                chartsData.daily = revLabels.map((label, i) => ({
                    date: revDates[i] || label,
                    revenue: revData[i] || 0,
                    orders: ordData[i] || 0,
                    ticket: (ordData[i] > 0) ? (revData[i] || 0) / ordData[i] : 0
                }));
            }
            
            // Build hourly array from hourly_chart
            const hourlyChartRaw = rawCharts.hourly_chart || {};
            const hourlyLabels = hourlyChartRaw.labels || [];
            const hourlyOrders = (hourlyChartRaw.datasets && hourlyChartRaw.datasets[0] && hourlyChartRaw.datasets[0].data) || [];
            const hourlyRevenue = hourlyChartRaw.revenue_data || [];
            
            if (hourlyLabels.length > 0) {
                chartsData.hourly = hourlyLabels.map((label, i) => ({
                    hour: parseInt(label) || i,
                    orders: hourlyOrders[i] || 0,
                    revenue: hourlyRevenue[i] || 0
                }));
            }
            
            // Store interruption periods for chart overlay
            chartsData.interruptions = rawCharts.interruptions || [];
            
            // Store forecast data for chart extension
            chartsData.forecast = rawCharts.forecast || null;

            // Also keep raw charts for any direct access
            chartsData._raw = rawCharts;
            
            updateUI();
            renderMenuPerformance();
            renderMainChart();
            updateInterruptionBanner();
            
            apiStatus.classList.remove('loading', 'error');
            apiStatus.querySelector('span:last-child').textContent = 'API Conectada';
        } else {
            throw new Error(data.error || 'Erro ao carregar dados');
        }
    } catch (error) {
        console.error('Error loading data:', error);
        apiStatus.classList.remove('loading');
        apiStatus.classList.add('error');
        apiStatus.querySelector('span:last-child').textContent = 'Erro de conexão';
    }
}

async function fetchOrders() {
    try {
        const response = await fetch(`/api/restaurant/${restaurantId}/orders?per_page=100`);
        if (response.status === 401) { window.location.href = '/login'; return; }
        const data = await response.json();
        
        if (data.success) {
            ordersData = data.orders || [];
            renderOrdersTable();
        }
    } catch (error) {
        console.error('Error loading orders:', error);
    }
}

function updateInterruptionBanner() {
    const banner = document.getElementById('interruptionBanner');
    const text = document.getElementById('interruptionText');
    
    if (interruptionsData && interruptionsData.length > 0) {
        const activeInt = interruptionsData[0];
        banner.classList.add('active');
        text.textContent = activeInt.description || 'Loja Fechada';
    } else {
        banner.classList.remove('active');
    }
}

// Filter Functions
function openFilterModal() {
    document.getElementById('filterModal').classList.add('active');
    document.body.style.overflow = 'hidden';
    populateMonthsGrid();
    syncModalWithCurrentFilter();
}

function closeFilterModal() {
    document.getElementById('filterModal').classList.remove('active');
    document.body.style.overflow = '';
}

function syncModalWithCurrentFilter() {
    const r = document.querySelector(`input[name="filterType"][value="${currentFilter.type}"]`);
    if (r) { r.checked = true; updateFilterContent(currentFilter.type); }
    if (currentFilter.type === 'current') {
        document.querySelectorAll('#filterContentCurrent .filter-quick-btn').forEach(b => 
            b.classList.toggle('active', b.dataset.period === currentFilter.period));
    }
    if (currentFilter.type === 'month' && currentFilter.month) {
        document.querySelectorAll('#filterMonthsGrid .filter-month-btn').forEach(b => 
            b.classList.toggle('active', b.dataset.month === currentFilter.month));
    }
    if (currentFilter.type === 'custom') {
        const sd = document.getElementById('filterDateStart');
        const ed = document.getElementById('filterDateEnd');
        if (sd) sd.value = currentFilter.startDate ? new Date(currentFilter.startDate).toISOString().split('T')[0] : '';
        if (ed) ed.value = currentFilter.endDate ? new Date(currentFilter.endDate).toISOString().split('T')[0] : '';
    }
}

function updateFilterContent(t) {
    document.querySelectorAll('.filter-content').forEach(e => e.classList.remove('active'));
    const c = document.getElementById(`filterContent${t.charAt(0).toUpperCase() + t.slice(1)}`);
    if (c) c.classList.add('active');
}

function populateMonthsGrid() {
    const g = document.getElementById('filterMonthsGrid');
    if (!g) return;
    let m = [];
    const n = new Date();
    for (let i = 0; i < 6; i++) {
        const d = new Date(n.getFullYear(), n.getMonth() - i, 1);
        const k = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
        const l = d.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
        m.push({ value: k, label: l.charAt(0).toUpperCase() + l.slice(1) });
    }
    g.innerHTML = m.map(x => `<button class="filter-month-btn${currentFilter.month === x.value ? ' active' : ''}" data-month="${x.value}">${x.label}</button>`).join('');
    g.querySelectorAll('.filter-month-btn').forEach(b => b.addEventListener('click', function() {
        g.querySelectorAll('.filter-month-btn').forEach(x => x.classList.remove('active'));
        this.classList.add('active');
    }));
}

function applyFilter() {
    const t = document.querySelector('input[name="filterType"]:checked').value;
    currentFilter.type = t;
    if (t === 'current') {
        const a = document.querySelector('#filterContentCurrent .filter-quick-btn.active');
        currentFilter.period = a ? a.dataset.period : '7days';
    } else if (t === 'month') {
        const a = document.querySelector('#filterMonthsGrid .filter-month-btn.active');
        currentFilter.month = a ? a.dataset.month : null;
    } else if (t === 'custom') {
        currentFilter.startDate = document.getElementById('filterDateStart').value ? new Date(document.getElementById('filterDateStart').value) : null;
        currentFilter.endDate = document.getElementById('filterDateEnd').value ? new Date(document.getElementById('filterDateEnd').value) : null;
    }
    updateFilterLabel();
    closeFilterModal();
    fetchRestaurantData();
}

function updateFilterLabel() {
    const l = document.getElementById('filterPeriodLabel');
    if (currentFilter.type === 'current') {
        const m = { '7days': 'Últimos 7 dias', '15days': 'Últimos 15 dias', '30days': 'Últimos 30 dias' };
        l.textContent = m[currentFilter.period] || 'Últimos 7 dias';
    } else if (currentFilter.type === 'month' && currentFilter.month) {
        const [y, m] = currentFilter.month.split('-');
        const d = new Date(y, parseInt(m) - 1);
        l.textContent = d.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
    } else {
        l.textContent = 'Personalizado';
    }
}

function getFilterDateRange() {
    const n = new Date();
    let s, e;
    if (currentFilter.type === 'current') {
        e = new Date(n);
        s = new Date(n);
        const d = { '7days': 7, '15days': 15, '30days': 30 };
        s.setDate(s.getDate() - (d[currentFilter.period] || 7));
    } else if (currentFilter.type === 'month' && currentFilter.month) {
        const [y, m] = currentFilter.month.split('-');
        s = new Date(y, parseInt(m) - 1, 1);
        e = new Date(y, parseInt(m), 0);
    } else {
        s = currentFilter.startDate || new Date(n.setDate(n.getDate() - 7));
        e = currentFilter.endDate || new Date();
    }
    return { startDate: s, endDate: e };
}

function initializeFilterListeners() {
    document.querySelectorAll('input[name="filterType"]').forEach(r => 
        r.addEventListener('change', function() { updateFilterContent(this.value); }));
    document.querySelectorAll('#filterContentCurrent .filter-quick-btn').forEach(b => 
        b.addEventListener('click', function() {
            document.querySelectorAll('#filterContentCurrent .filter-quick-btn').forEach(x => x.classList.remove('active'));
            this.classList.add('active');
        }));
}

// Tab Switching
function switchTab(v) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelector(`.tab[data-view="${v}"]`).classList.add('active');
    document.querySelectorAll('.view-container').forEach(c => c.classList.remove('active'));
    document.getElementById(`${v}View`).classList.add('active');
    
    if (v === 'orders' && ordersData.length === 0) fetchOrders();
    if (v === 'hourly' && !hourlyChart) renderHourlyChart();
    if (v === 'feedback') { renderReviews(); renderFeedbackCharts(); }
}

// Refresh
function refreshData() {
    fetchRestaurantData();
    if (ordersData.length > 0) fetchOrders();
}

// UI Update
function updateUI() {
    if (!restaurantData) return;
    
    // Header
    if (restaurantData.name) document.getElementById('restaurantName').textContent = restaurantData.name;
    if (restaurantData.manager) document.getElementById('restaurantManager').textContent = restaurantData.manager;
    
    // Rating
    if (restaurantData.rating) {
        document.getElementById('restaurantRating').style.display = 'inline-flex';
        document.getElementById('ratingValue').textContent = restaurantData.rating.toFixed(1);
    }
    
    // Super badge
    if (restaurantData.isSuperRestaurant || restaurantData.isSuper || restaurantData.super) {
        document.getElementById('restaurantSuper').style.display = 'inline-flex';
    }
    
    // Metrics - map backend field names to UI
    const m = restaurantData.metrics || {};
    const t = m.trends || {};
    
    // KPIs: revenue = liquido (net), orders = vendas (count), ticket = ticket_medio, cancellation = percent_cancelamento
    updateKPI('kpiRevenue', formatCurrency(m.liquido || restaurantData.revenue || 0), t.liquido);
    updateKPI('kpiOrders', m.vendas || m.total_pedidos || restaurantData.orders || 0, t.vendas);
    updateKPI('kpiCancellation', `${(m.percent_cancelamento || 0).toFixed(1)}%`, -(t.cancelamentos || 0), true);
    
    // Revenue metrics
    document.getElementById('metricGross').textContent = formatCurrency(m.valor_bruto || 0);
    document.getElementById('metricDiscount').textContent = formatCurrency(m.descontos || 0);
    document.getElementById('metricDelivery').textContent = formatCurrency(m.via_loja || 0);
    document.getElementById('metricCommission').textContent = `${(m.percent_desconto || 0).toFixed(1)}%`;
    document.getElementById('metricNet').textContent = formatCurrency(m.liquido || restaurantData.revenue || 0);
    
    // Order metrics
    document.getElementById('metricCompleted').textContent = m.vendas || m.total_pedidos || restaurantData.orders || 0;
    document.getElementById('metricCancelled').textContent = m.cancelamentos || 0;
    document.getElementById('metricItems').textContent = m.novos_clientes || 0;
    document.getElementById('metricDays').textContent = m.tempo_aberto_hours || 0;
}

function ensureMenuPerformanceSection() {
    if (document.getElementById('menuPerformanceSection')) return;
    const dashboardView = document.getElementById('dashboardView');
    if (!dashboardView) return;
    const section = document.createElement('section');
    section.className = 'data-section';
    section.id = 'menuPerformanceSection';
    section.innerHTML = `
        <div class="data-header"><h3>Menu Item Performance</h3></div>
        <div style="padding: 16px 20px; border-bottom: 1px solid var(--border-subtle); display: flex; gap: 12px; flex-wrap: wrap;" id="menuSummary"></div>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(340px, 1fr)); gap: 0; border-top: 1px solid var(--border-subtle);">
            <div class="table-wrapper">
                <table class="data-table">
                    <thead><tr><th colspan="4">Top Itens</th></tr><tr><th>Item</th><th>Qtd</th><th>Receita</th><th>Cancel.</th></tr></thead>
                    <tbody id="menuTopItemsBody"></tbody>
                </table>
            </div>
            <div class="table-wrapper" style="border-left: 1px solid var(--border-subtle);">
                <table class="data-table">
                    <thead><tr><th colspan="4">Itens de Atenção</th></tr><tr><th>Item</th><th>Qtd</th><th>Receita</th><th>Cancel.</th></tr></thead>
                    <tbody id="menuBottomItemsBody"></tbody>
                </table>
            </div>
        </div>
    `;
    dashboardView.appendChild(section);
}

function renderMenuPerformance() {
    ensureMenuPerformanceSection();

    const summaryEl = document.getElementById('menuSummary');
    const topBody = document.getElementById('menuTopItemsBody');
    const bottomBody = document.getElementById('menuBottomItemsBody');
    if (!summaryEl || !topBody || !bottomBody) return;

    if (!menuPerformanceData || !menuPerformanceData.summary) {
        summaryEl.innerHTML = '<span style="color: var(--text-muted); font-size: 0.9rem;">Sem dados de itens para o período selecionado.</span>';
        topBody.innerHTML = '<tr><td colspan="4" class="empty-state"><p>Sem dados</p></td></tr>';
        bottomBody.innerHTML = '<tr><td colspan="4" class="empty-state"><p>Sem dados</p></td></tr>';
        return;
    }

    const s = menuPerformanceData.summary;
    summaryEl.innerHTML = `
        <span class="platform-badge">Itens únicos: ${s.total_unique_items || 0}</span>
        <span class="platform-badge">Qtd vendida: ${s.total_quantity_sold || 0}</span>
        <span class="platform-badge">Receita itens: ${formatCurrency(s.total_item_revenue || 0)}</span>
        <span class="platform-badge">Avaliação média: ${(s.average_item_rating || 0).toFixed(2)}</span>
    `;

    const topItems = menuPerformanceData.top_items || [];
    const bottomItems = menuPerformanceData.bottom_items || [];

    topBody.innerHTML = topItems.length > 0
        ? topItems.map(item => `
            <tr>
                <td>${item.item_name || '-'}</td>
                <td>${item.quantity_sold || 0}</td>
                <td>${formatCurrency(item.revenue || 0)}</td>
                <td>${(item.cancellation_rate || 0).toFixed(1)}%</td>
            </tr>
        `).join('')
        : '<tr><td colspan="4" class="empty-state"><p>Sem dados</p></td></tr>';

    bottomBody.innerHTML = bottomItems.length > 0
        ? bottomItems.map(item => `
            <tr>
                <td>${item.item_name || '-'}</td>
                <td>${item.quantity_total || 0}</td>
                <td>${formatCurrency(item.revenue || 0)}</td>
                <td>${(item.cancellation_rate || 0).toFixed(1)}%</td>
            </tr>
        `).join('')
        : '<tr><td colspan="4" class="empty-state"><p>Sem dados</p></td></tr>';
}

function updateKPI(id, v, t, inv = false) {
    document.getElementById(id).textContent = v;
    const e = document.getElementById(id + 'Trend');
    if (e && t !== undefined && !isNaN(t)) {
        const p = inv ? t < 0 : t > 0;
        e.className = `kpi-trend ${p ? 'positive' : 'negative'}`;
        e.innerHTML = `<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${p ? 'M13 7h8m0 0v8m0-8l-8 8-4-4-6 6' : 'M13 17h8m0 0V9m0 8l-8-8-4 4-6-6'}"/></svg>${t > 0 ? '+' : ''}${t.toFixed(1)}%`;
    }
}

function formatCurrency(v) {
    return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(v);
}

// Charts
function renderMainChart() {
    if (!chartsData || !chartsData.daily) return;

    const ctx = document.getElementById('mainChart').getContext('2d');
    if (mainChart) mainChart.destroy();

    const data = chartsData.daily;
    const histLabels = data.map(d => {
        if (d.date && d.date.includes('-')) {
            return new Date(d.date + 'T12:00:00').toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' });
        }
        return d.date || '--';
    });
    const histValues = activeChartType === 'revenue' ? data.map(d => d.revenue || d.vendas || 0) :
                 activeChartType === 'orders' ? data.map(d => d.orders || d.pedidos || 0) :
                 data.map(d => d.revenue || d.vendas || 0);

    const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
    const fc = chartsData.forecast;
    const hasForecast = fc && fc.labels && fc.labels.length > 0;

    let allLabels, datasets, boundaryIndex;

    if (hasForecast) {
        boundaryIndex = histLabels.length - 1;
        const fcLabels = fc.labels;
        allLabels = [...histLabels, ...fcLabels];
        const fcValues = activeChartType === 'orders' ? fc.orders : fc.revenue;

        // Historical dataset: values for historical indices, null for forecast
        const histData = [...histValues, ...fcValues.map(() => null)];
        // Forecast dataset: null for historical, but overlap last historical point for connection
        const fcData = [...histValues.map((_, i) => i === boundaryIndex ? histValues[boundaryIndex] : null), ...fcValues];

        datasets = [
            { data: histData, borderColor: '#f97015', backgroundColor: 'rgba(249,112,21,0.1)', borderWidth: 2, fill: true, tension: 0.4, pointRadius: 4, pointHoverRadius: 6, pointBackgroundColor: '#f97015', pointBorderColor: isDark ? '#0a0a0a' : '#fff', pointBorderWidth: 2, label: 'Dados' },
            { data: fcData, borderColor: 'rgba(249,112,21,0.5)', backgroundColor: 'rgba(249,112,21,0.05)', borderWidth: 2, borderDash: [6, 4], fill: true, tension: 0.4, pointRadius: 3, pointHoverRadius: 5, pointBackgroundColor: 'rgba(249,112,21,0.5)', pointBorderColor: isDark ? '#0a0a0a' : '#fff', pointBorderWidth: 2, pointStyle: 'circle', label: 'Previsão' }
        ];
    } else {
        boundaryIndex = -1;
        allLabels = histLabels;
        datasets = [{ data: histValues, borderColor: '#f97015', backgroundColor: 'rgba(249,112,21,0.1)', borderWidth: 2, fill: true, tension: 0.4, pointRadius: 4, pointHoverRadius: 6, pointBackgroundColor: '#f97015', pointBorderColor: isDark ? '#0a0a0a' : '#fff', pointBorderWidth: 2 }];
    }

    // Plugin: vertical separator line between historical and forecast
    const forecastSeparator = {
        id: 'forecastSeparator',
        afterDraw(chart) {
            if (boundaryIndex < 0) return;
            const { ctx: c, chartArea: { top, bottom }, scales: { x } } = chart;
            const xPos = x.getPixelForValue(boundaryIndex);
            c.save();
            c.beginPath();
            c.setLineDash([4, 4]);
            c.strokeStyle = isDark ? '#525252' : '#d4d4d4';
            c.lineWidth = 1;
            c.moveTo(xPos, top);
            c.lineTo(xPos, bottom);
            c.stroke();
            // Label
            c.setLineDash([]);
            c.font = '10px Inter, sans-serif';
            c.fillStyle = isDark ? '#737373' : '#a3a3a3';
            c.textAlign = 'left';
            c.fillText('Previsão', xPos + 6, top + 12);
            c.restore();
        }
    };

    mainChart = new Chart(ctx, {
        type: 'line',
        data: { labels: allLabels, datasets },
        options: {
            responsive: true, maintainAspectRatio: false,
            plugins: { legend: { display: false }, tooltip: { backgroundColor: isDark ? '#262626' : '#fff', titleColor: isDark ? '#fff' : '#171717', bodyColor: isDark ? '#a3a3a3' : '#525252', borderColor: isDark ? '#404040' : '#e5e5e5', borderWidth: 1, padding: 12, cornerRadius: 8, displayColors: false, callbacks: { label: c => { const prefix = c.datasetIndex === 1 ? '(Previsão) ' : ''; return activeChartType === 'orders' ? `${prefix}${c.parsed.y} pedidos` : `${prefix}${formatCurrency(c.parsed.y)}`; } } } },
            scales: { x: { grid: { color: isDark ? '#262626' : '#f5f5f5' }, ticks: { color: isDark ? '#737373' : '#a3a3a3' } }, y: { grid: { color: isDark ? '#262626' : '#f5f5f5' }, ticks: { color: isDark ? '#737373' : '#a3a3a3', callback: v => activeChartType === 'orders' ? v : 'R$ ' + (v / 1000).toFixed(0) + 'k' } } }
        },
        plugins: [forecastSeparator]
    });

    // Stats use only historical values
    const avg = histValues.reduce((a, b) => a + b, 0) / histValues.length, max = Math.max(...histValues), min = Math.min(...histValues);
    document.getElementById('chartAvg').textContent = activeChartType === 'orders' ? avg.toFixed(0) + ' pedidos' : formatCurrency(avg);
    document.getElementById('chartMax').textContent = activeChartType === 'orders' ? max + ' pedidos' : formatCurrency(max);
    document.getElementById('chartMin').textContent = activeChartType === 'orders' ? min + ' pedidos' : formatCurrency(min);

    // Toggle forecast badge visibility
    const fcBadge = document.getElementById('forecastBadge');
    if (fcBadge) fcBadge.style.display = hasForecast ? 'inline-flex' : 'none';
}

function renderHourlyChart() {
    if (!chartsData || !chartsData.hourly) return;
    
    const ctx = document.getElementById('hourlyChart').getContext('2d');
    if (hourlyChart) hourlyChart.destroy();
    
    const data = chartsData.hourly;
    const labels = data.map(d => `${d.hour}h`);
    const values = activeHourlyType === 'revenue' ? data.map(d => d.revenue || 0) : data.map(d => d.orders || 0);
    const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
    
    // Build interruption zones for the chart background
    const interruptions = chartsData.interruptions || [];
    // Also check top-level interruptionsData
    const allInterruptions = interruptions.length > 0 ? interruptions : (interruptionsData || []);
    
    // Chart.js plugin to draw shaded interruption zones
    const interruptionPlugin = {
        id: 'interruptionZones',
        beforeDraw(chart) {
            if (!allInterruptions || allInterruptions.length === 0) return;
            const { ctx: c, chartArea: { left, right, top, bottom }, scales: { x } } = chart;
            
            allInterruptions.forEach(int => {
                let startH, endH;
                if (int.start_hour !== undefined) {
                    startH = int.start_hour;
                    endH = int.end_hour;
                } else if (int.start) {
                    try {
                        const s = new Date(int.start);
                        const e = new Date(int.end);
                        startH = s.getHours();
                        endH = e.getHours();
                    } catch(e) { return; }
                } else { return; }
                
                // Get pixel positions for the hour range
                const startIdx = Math.max(0, startH);
                const endIdx = Math.min(23, endH || startH + 1);
                
                const x0 = x.getPixelForValue(startIdx) - (x.getPixelForValue(1) - x.getPixelForValue(0)) / 2;
                const x1 = x.getPixelForValue(endIdx) + (x.getPixelForValue(1) - x.getPixelForValue(0)) / 2;
                
                // Draw shaded zone
                c.save();
                c.fillStyle = isDark ? 'rgba(244, 63, 94, 0.12)' : 'rgba(244, 63, 94, 0.08)';
                c.fillRect(x0, top, x1 - x0, bottom - top);
                
                // Draw left/right borders
                c.strokeStyle = isDark ? 'rgba(244, 63, 94, 0.4)' : 'rgba(244, 63, 94, 0.3)';
                c.lineWidth = 1;
                c.setLineDash([4, 4]);
                c.beginPath();
                c.moveTo(x0, top); c.lineTo(x0, bottom);
                c.moveTo(x1, top); c.lineTo(x1, bottom);
                c.stroke();
                
                // Draw label
                c.setLineDash([]);
                c.fillStyle = isDark ? 'rgba(244, 63, 94, 0.8)' : 'rgba(244, 63, 94, 0.7)';
                c.font = '600 10px Outfit, sans-serif';
                c.textAlign = 'center';
                const label = int.description || 'Fechado';
                const timeLabel = (int.start_hour !== undefined) 
                    ? `${String(startH).padStart(2,'0')}:00-${String(endH).padStart(2,'0')}:00` 
                    : `${int.start || ''}-${int.end || ''}`;
                c.fillText(label, (x0 + x1) / 2, top + 14);
                c.font = '400 9px Outfit, sans-serif';
                c.fillText(timeLabel, (x0 + x1) / 2, top + 26);
                c.restore();
            });
        }
    };
    
    hourlyChart = new Chart(ctx, {
        type: 'bar',
        data: { labels, datasets: [{ data: values, backgroundColor: 'rgba(249,112,21,0.2)', borderColor: '#f97015', borderWidth: 2, borderRadius: 6 }] },
        options: {
            responsive: true, maintainAspectRatio: false,
            plugins: { legend: { display: false },
                tooltip: {
                    backgroundColor: isDark ? '#262626' : '#fff', titleColor: isDark ? '#fff' : '#171717', bodyColor: isDark ? '#a3a3a3' : '#525252', borderColor: isDark ? '#404040' : '#e5e5e5', borderWidth: 1, padding: 12, cornerRadius: 8, displayColors: false,
                    callbacks: { label: c => activeHourlyType === 'revenue' ? formatCurrency(c.parsed.y) : `${c.parsed.y} pedidos` }
                }
            },
            scales: {
                x: { grid: { display: false }, ticks: { color: isDark ? '#737373' : '#a3a3a3' } },
                y: { grid: { color: isDark ? '#262626' : '#f5f5f5' }, ticks: { color: isDark ? '#737373' : '#a3a3a3', callback: v => activeHourlyType === 'revenue' ? 'R$ ' + (v >= 1000 ? (v/1000).toFixed(0) + 'k' : v.toFixed(0)) : v } }
            }
        },
        plugins: [interruptionPlugin]
    });
    
    const maxIdx = values.indexOf(Math.max(...values));
    document.getElementById('hourlyPeak').textContent = labels[maxIdx] || '--';
    document.getElementById('hourlyMax').textContent = activeHourlyType === 'revenue' ? formatCurrency(values[maxIdx] || 0) : (values[maxIdx] || 0) + ' pedidos';
}

function switchChartTab(c) { activeChartType = c; document.querySelectorAll('.chart-tab[data-chart]').forEach(t => t.classList.toggle('active', t.dataset.chart === c)); renderMainChart(); }
function switchHourlyTab(t) { activeHourlyType = t; document.querySelectorAll('[data-hourly]').forEach(e => e.classList.toggle('active', e.dataset.hourly === t)); renderHourlyChart(); }

// Orders Table
function renderOrdersTable() {
    const tb = document.getElementById('ordersTableBody');
    if (!ordersData || ordersData.length === 0) {
        tb.innerHTML = `<tr><td colspan="5" class="empty-state"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/></svg><p>Nenhum pedido</p></td></tr>`;
        return;
    }
    tb.innerHTML = ordersData.slice(0, 100).map(o => {
        const d = new Date(o.createdAt);
        const sc = o.orderStatus === 'CONCLUDED' ? 'concluded' : o.orderStatus === 'CONFIRMED' ? 'confirmed' : 'cancelled';
        const st = o.orderStatus === 'CONCLUDED' ? 'Concluído' : o.orderStatus === 'CONFIRMED' ? 'Confirmado' : 'Cancelado';
        return `<tr><td><span class="order-id">${o.displayId || o.id?.substring(0, 8) || '-'}</span></td><td>${d.toLocaleDateString('pt-BR')} ${d.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })}</td><td>${formatCurrency(o.total?.orderAmount || o.totalPrice || 0)}</td><td><span class="status-badge ${sc}">${st}</span></td><td>${o.payments?.[0]?.name || o.payment?.method || '-'}</td></tr>`;
    }).join('');
}

// Reviews
function escapeHTML(str) {
    if (!str) return '';
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
}

function renderReviews() {
    if (!reviewsData) return;
    renderReviewsOverview();
    renderRatingTrend();
    renderReviewsList();
    initReviewFilters();
}

function renderStarsHTML(rating, size = 16) {
    let html = '';
    for (let i = 1; i <= 5; i++) {
        const cls = i <= rating ? 'star-filled' : 'star-empty';
        html += `<svg class="${cls}" width="${size}" height="${size}" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>`;
    }
    return html;
}

function renderReviewsOverview() {
    const rd = reviewsData;
    document.getElementById('reviewsAvgRating').textContent = rd.average_rating > 0 ? rd.average_rating.toFixed(1) : '-';
    document.getElementById('reviewsStars').innerHTML = renderStarsHTML(Math.round(rd.average_rating), 20);
    document.getElementById('reviewsTotalCount').textContent = `${rd.total_reviews} avaliação${rd.total_reviews !== 1 ? 'es' : ''}`;

    const barsEl = document.getElementById('reviewsBars');
    const dist = rd.rating_distribution || {};
    let barsHTML = '';
    for (let i = 5; i >= 1; i--) {
        const count = dist[i] || dist[String(i)] || 0;
        const pct = rd.total_reviews > 0 ? (count / rd.total_reviews * 100) : 0;
        barsHTML += `<div class="reviews-bar-row">
            <span class="reviews-bar-label">${i}★</span>
            <div class="reviews-bar-track"><div class="reviews-bar-fill" style="width:${pct}%"></div></div>
            <span class="reviews-bar-count">${count}</span>
        </div>`;
    }
    barsEl.innerHTML = barsHTML;
}

function renderRatingTrend() {
    if (!reviewsData || !reviewsData.items || reviewsData.items.length === 0) return;

    const dailyRatings = {};
    reviewsData.items.forEach(r => {
        if (!r.date) return;
        try {
            const d = new Date(r.date);
            const key = d.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' });
            if (!dailyRatings[key]) dailyRatings[key] = [];
            dailyRatings[key].push(r.rating);
        } catch(e) {}
    });

    const sortedDates = Object.keys(dailyRatings);
    const avgData = sortedDates.map(d => {
        const vals = dailyRatings[d];
        return +(vals.reduce((a, b) => a + b, 0) / vals.length).toFixed(2);
    });

    const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
    const cv = document.getElementById('ratingTrendChart');
    if (!cv) return;
    if (ratingTrendChart) ratingTrendChart.destroy();

    ratingTrendChart = new Chart(cv.getContext('2d'), {
        type: 'line',
        data: {
            labels: sortedDates,
            datasets: [{
                label: 'Avaliação Média',
                data: avgData,
                borderColor: '#f59e0b',
                backgroundColor: 'rgba(245,158,11,0.1)',
                fill: true,
                tension: 0.4,
                borderWidth: 2.5,
                pointRadius: 3,
                pointBackgroundColor: '#f59e0b',
                pointBorderColor: isDark ? '#0a0a0a' : '#fff',
                pointBorderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
                y: {
                    min: 0, max: 5,
                    grid: { color: isDark ? '#262626' : '#f5f5f5' },
                    ticks: { stepSize: 1, color: isDark ? '#737373' : '#a3a3a3' }
                },
                x: {
                    grid: { display: false },
                    ticks: { color: isDark ? '#737373' : '#a3a3a3', maxTicksLimit: 10 }
                }
            }
        }
    });
}

function getFilteredReviews() {
    if (!reviewsData || !reviewsData.items) return [];
    if (reviewsFilter === 'all') return reviewsData.items;
    const f = parseInt(reviewsFilter);
    return reviewsData.items.filter(r => r.rating === f);
}

function renderReviewsList() {
    const filtered = getFilteredReviews();
    const listEl = document.getElementById('reviewsList');
    const loadMoreBtn = document.getElementById('reviewsLoadMore');
    reviewsPage = 0;

    if (filtered.length === 0) {
        listEl.innerHTML = '<div class="empty-state"><p>Nenhuma avaliação encontrada</p></div>';
        loadMoreBtn.style.display = 'none';
        return;
    }

    const toShow = filtered.slice(0, REVIEWS_PER_PAGE);
    listEl.innerHTML = toShow.map(renderReviewCard).join('');
    loadMoreBtn.style.display = filtered.length > REVIEWS_PER_PAGE ? 'block' : 'none';
    reviewsPage = 1;
}

function loadMoreReviews() {
    const filtered = getFilteredReviews();
    const start = reviewsPage * REVIEWS_PER_PAGE;
    const end = start + REVIEWS_PER_PAGE;
    const toShow = filtered.slice(start, end);

    const listEl = document.getElementById('reviewsList');
    toShow.forEach(r => {
        listEl.insertAdjacentHTML('beforeend', renderReviewCard(r));
    });
    reviewsPage++;

    if (end >= filtered.length) {
        document.getElementById('reviewsLoadMore').style.display = 'none';
    }
}

function renderReviewCard(review) {
    const name = escapeHTML(review.customer_name || 'Cliente');
    const initials = (review.customer_name || 'C').split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
    const date = review.date ? new Date(review.date).toLocaleDateString('pt-BR', { day: '2-digit', month: 'short', year: 'numeric' }) : '';

    let tagsHTML = '';
    if (review.compliments && review.compliments.length > 0) {
        tagsHTML += review.compliments.map(c => `<span class="review-tag positive">${escapeHTML(c)}</span>`).join('');
    }
    if (review.complaints && review.complaints.length > 0) {
        tagsHTML += review.complaints.map(c => `<span class="review-tag negative">${escapeHTML(c)}</span>`).join('');
    }

    return `<div class="review-card">
        <div class="review-card-top">
            <div class="review-customer">
                <div class="review-avatar">${initials}</div>
                <div class="review-customer-info">
                    <span class="review-customer-name">${name}</span>
                    <span class="review-date">${date}</span>
                </div>
            </div>
            <div class="review-stars">${renderStarsHTML(review.rating)}</div>
        </div>
        ${review.comment ? `<p class="review-comment">${escapeHTML(review.comment)}</p>` : ''}
        ${tagsHTML ? `<div class="review-tags">${tagsHTML}</div>` : ''}
        <div class="review-order-id">Pedido ${escapeHTML(review.order_id)}</div>
    </div>`;
}

function initReviewFilters() {
    document.querySelectorAll('.reviews-filter-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.reviews-filter-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            reviewsFilter = this.dataset.filter;
            renderReviewsList();
        });
    });
}

// Feedback Charts
function renderFeedbackCharts() {
    if (!ordersData || ordersData.length === 0) {
        fetchOrders().then(() => buildFeedbackCharts());
    } else {
        buildFeedbackCharts();
    }
}

function buildFeedbackCharts() {
    const cm = {}, cp = {}, cr = {}, co = {};
    ordersData.forEach(o => {
        if (o.feedback?.compliments) o.feedback.compliments.forEach(c => cm[c] = (cm[c] || 0) + 1);
        if (o.feedback?.complaints) o.feedback.complaints.forEach(c => cp[c] = (cp[c] || 0) + 1);
        if (o.orderStatus === 'CANCELLED' && o.cancellation) {
            if (o.cancellation.reason) cr[o.cancellation.reason] = (cr[o.cancellation.reason] || 0) + 1;
            if (o.cancellation.origin) {
                const l = o.cancellation.origin === 'CONSUMER' ? 'Consumidor' : o.cancellation.origin === 'MERCHANT' ? 'Loja' : 'iFood';
                co[l] = (co[l] || 0) + 1;
            }
        }
    });
    Object.keys(feedbackCharts).forEach(k => { if (feedbackCharts[k]) feedbackCharts[k].destroy(); });
    renderBarChart('complimentsChart', cm, 'compliments', '#10b981');
    renderBarChart('complaintsChart', cp, 'complaints', '#f43f5e');
    renderBarChart('cancellationReasonsChart', cr, 'cancellationReasons', '#f59e0b');
    renderBarChart('cancellationOriginsChart', co, 'cancellationOrigins', '#0ea5e9');
}

function renderBarChart(id, dm, k, c) {
    const cv = document.getElementById(id);
    if (!cv) return;
    const lb = Object.keys(dm), dt = Object.values(dm);
    if (lb.length === 0) {
        cv.parentElement.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:220px;color:var(--text-muted)">Sem dados</div>';
        return;
    }
    const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
    feedbackCharts[k] = new Chart(cv.getContext('2d'), {
        type: 'bar',
        data: { labels: lb, datasets: [{ data: dt, backgroundColor: c + '33', borderColor: c, borderWidth: 2, borderRadius: 6 }] },
        options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { beginAtZero: true, grid: { color: isDark ? '#262626' : '#f5f5f5' }, ticks: { stepSize: 1, color: isDark ? '#737373' : '#a3a3a3' } }, y: { grid: { display: false }, ticks: { color: isDark ? '#737373' : '#a3a3a3', font: { size: 11 } } } } }
    });
}

function showToast(message) {
    document.querySelectorAll('.toast').forEach(t => t.remove());
    const toast = document.createElement('div');
    toast.className = 'toast';
    toast.textContent = message;
    document.body.appendChild(toast);
    setTimeout(() => {
        toast.style.opacity = '0';
        setTimeout(() => toast.remove(), 300);
    }, 2500);
}

function exportDashboardPdf() {
    showToast('Abrindo impressao. Selecione "Salvar como PDF".');
    setTimeout(() => window.print(), 120);
}

// Theme
function toggleTheme() {
    const t = document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
    document.documentElement.setAttribute('data-theme', t);
    localStorage.setItem('theme', t);
    document.getElementById('sunIcon').style.display = t === 'dark' ? 'block' : 'none';
    document.getElementById('moonIcon').style.display = t === 'dark' ? 'none' : 'block';
    if (mainChart) renderMainChart();
    if (hourlyChart) renderHourlyChart();
}

// Init
window.addEventListener('DOMContentLoaded', async function() {
    const t = localStorage.getItem('theme') || 'light';
    document.documentElement.setAttribute('data-theme', t);
    document.getElementById('sunIcon').style.display = t === 'dark' ? 'block' : 'none';
    document.getElementById('moonIcon').style.display = t === 'dark' ? 'none' : 'block';
    
    initializeFilterListeners();
    updateFilterLabel();
    
    document.querySelectorAll('.tab').forEach(b => b.addEventListener('click', function() { switchTab(this.dataset.view); }));
    document.querySelectorAll('.chart-tab[data-chart]').forEach(b => b.addEventListener('click', function() { switchChartTab(this.dataset.chart); }));
    document.querySelectorAll('.chart-tab[data-hourly]').forEach(b => b.addEventListener('click', function() { switchHourlyTab(this.dataset.hourly); }));
    fetchRestaurantData();
});

document.addEventListener('keydown', e => { if (e.key === 'Escape') closeFilterModal(); });
document.getElementById('filterModal').addEventListener('click', function(e) { if (e.target === this) closeFilterModal(); });
    </script>
</body>
</html>
