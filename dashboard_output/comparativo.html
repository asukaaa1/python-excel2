<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comparativo por Gestor - Dashboard</title>
    <link rel="icon" type="image/png" sizes="32x32" href="/static/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/static/favicon-16x16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/static/apple-touch-icon.png">
    <link rel="manifest" href="/static/site.webmanifest">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --font-body: 'Plus Jakarta Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            --font-mono: 'DM Mono', 'SF Mono', monospace;
            --bg-primary: #fafbfc; --bg-secondary: #f4f5f7; --bg-tertiary: #ebecf0; --bg-elevated: #ffffff;
            --text-primary: #1a1a2e; --text-secondary: #4a5568; --text-tertiary: #9ca3af;
            --border-light: #e5e7eb; --border-medium: #d1d5db;
            --primary-50: #fff8f1; --primary-100: #feedd6; --primary-500: #f97015; --primary-600: #e06510; --primary-700: #c2410c;
            --success-50: #ecfdf5; --success-500: #10b981; --success-600: #059669;
            --error-50: #fef2f2; --error-500: #ef4444; --error-600: #dc2626;
            --blue-50: #eff6ff; --blue-500: #3b82f6;
            --shadow-xs: 0 1px 2px 0 rgba(0,0,0,0.03); --shadow-sm: 0 1px 3px 0 rgba(0,0,0,0.06), 0 1px 2px -1px rgba(0,0,0,0.06);
            --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.08), 0 2px 4px -2px rgba(0,0,0,0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.08), 0 4px 6px -4px rgba(0,0,0,0.04);
            --shadow-xl: 0 20px 25px -5px rgba(0,0,0,0.1), 0 8px 10px -6px rgba(0,0,0,0.06);
            --shadow-glow: 0 0 30px rgba(249,112,21,0.15);
            --radius-sm: 0.375rem; --radius-md: 0.5rem; --radius-lg: 0.75rem; --radius-xl: 1rem; --radius-2xl: 1.25rem;
            --gradient-primary: linear-gradient(135deg, #f97015 0%, #f97015 50%, #e06510 100%);
            /* Compat aliases */
            --bg-card: var(--bg-elevated); --border: var(--border-light); --accent: var(--primary-500);
            --accent-hover: var(--primary-600); --green: var(--success-500); --green-bg: rgba(16,185,129,0.1);
            --red: var(--error-500); --red-bg: rgba(239,68,68,0.1); --blue: var(--blue-500);
            --text-muted: var(--text-tertiary);
        }
        [data-theme="dark"] {
            --bg-primary: #000000; --bg-secondary: #0a0a0a; --bg-tertiary: #0f0f0f; --bg-elevated: #0a0a0a;
            --text-primary: #ffffff; --text-secondary: #a0a0a0; --text-tertiary: #666666;
            --border-light: #1a1a1a; --border-medium: #262626;
            --shadow-xs: 0 1px 2px 0 rgba(0,0,0,0.5); --shadow-sm: 0 1px 3px 0 rgba(0,0,0,0.6);
            --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.7); --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.8);
            --shadow-xl: 0 20px 25px -5px rgba(0,0,0,0.9); --shadow-glow: 0 0 40px rgba(249,112,21,0.15);
            --bg-card: var(--bg-elevated); --border: var(--border-light);
            --green-bg: rgba(16,185,129,0.15); --red-bg: rgba(239,68,68,0.15);
            --bg-hover: #1a1a1a;
        }
        body { 
            font-family: var(--font-body); 
            background: var(--bg-primary); 
            color: var(--text-primary); 
            line-height: 1.6; 
            min-height: 100vh;
            transition: background-color 0.3s, color 0.3s;
            -webkit-font-smoothing: antialiased;
        }

        @keyframes fadeInUp { from { opacity: 0; transform: translateY(16px); } to { opacity: 1; transform: translateY(0); } }
        .animate-in { animation: fadeInUp 0.5s cubic-bezier(0.4, 0, 0.2, 1) both; }
        .animate-in:nth-child(1) { animation-delay: 0.05s; }
        .animate-in:nth-child(2) { animation-delay: 0.1s; }
        .animate-in:nth-child(3) { animation-delay: 0.15s; }
        .animate-in:nth-child(4) { animation-delay: 0.2s; }
        
        /* Sidebar */
        .sidebar { position: fixed; top: 0; left: 0; width: 280px; height: 100vh; background: var(--bg-elevated); border-right: 1px solid var(--border-light); display: flex; flex-direction: column; z-index: 100; transform: translateX(-100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .sidebar.open { transform: translateX(0); }
        .sidebar-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); z-index: 99; opacity: 0; visibility: hidden; transition: all 0.3s; }
        .sidebar-overlay.show { opacity: 1; visibility: visible; }
        .sidebar-header { padding: 1.5rem; border-bottom: 1px solid var(--border-light); }
        .sidebar-brand { display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1.25rem; }
        .sidebar-logo { display: flex; align-items: center; }
        .sidebar-logo img { height: 26px; width: auto; display: block; object-fit: contain; }
        .sidebar-brand-text { font-size: 1.25rem; font-weight: 800; color: var(--text-primary); letter-spacing: -0.02em; }
        .sidebar-user { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: var(--bg-secondary); border-radius: var(--radius-lg); }
        .sidebar-avatar { width: 44px; height: 44px; border-radius: var(--radius-lg); background: var(--gradient-primary); display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 1rem; }
        .sidebar-user-info h3 { font-size: 0.875rem; font-weight: 600; color: var(--text-primary); margin-bottom: 2px; }
        .sidebar-user-info p { font-size: 0.75rem; color: var(--text-tertiary); display: flex; align-items: center; gap: 0.5rem; }
        .role-dot { width: 6px; height: 6px; border-radius: 50%; background: var(--success-500); box-shadow: 0 0 6px var(--success-500); }
        .sidebar-nav { flex: 1; padding: 1rem 0.75rem; overflow-y: auto; }
        .sidebar-section { margin-bottom: 1.5rem; }
        .sidebar-section-title { font-size: 0.6875rem; font-weight: 700; color: var(--text-tertiary); text-transform: uppercase; letter-spacing: 0.1em; padding: 0 1rem; margin-bottom: 0.5rem; }
        .sidebar-link { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 1rem; margin: 0.25rem 0; border-radius: var(--radius-lg); color: var(--text-secondary); text-decoration: none; font-size: 0.875rem; font-weight: 500; transition: all 0.2s; cursor: pointer; border: none; background: none; width: 100%; text-align: left; }
        .sidebar-link:hover { background: var(--bg-tertiary); color: var(--text-primary); }
        .sidebar-link.active { background: var(--primary-50); color: var(--primary-600); font-weight: 600; }
        [data-theme="dark"] .sidebar-link.active { background: rgba(249,112,21,0.1); color: var(--primary-500); }
        .sidebar-link svg { width: 20px; height: 20px; opacity: 0.7; transition: all 0.2s; }
        .sidebar-link:hover svg, .sidebar-link.active svg { opacity: 1; }
        .sidebar-footer { padding: 1rem 1.25rem; border-top: 1px solid var(--border-light); }
        .sidebar-footer-btn { display: flex; align-items: center; justify-content: center; gap: 0.5rem; width: 100%; padding: 0.75rem; border-radius: var(--radius-lg); background: transparent; border: 1px solid var(--border-medium); color: var(--text-secondary); font-size: 0.875rem; font-weight: 500; cursor: pointer; transition: all 0.2s; font-family: var(--font-body); }
        .sidebar-footer-btn:hover { background: var(--error-50); border-color: var(--error-500); color: var(--error-500); }
        [data-theme="dark"] .sidebar-footer-btn:hover { background: rgba(239,68,68,0.1); }

        /* Container & Header */
        .container { max-width: 1680px; margin: 0 auto; padding: 1.5rem; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 1rem; }
        .header-left { display: flex; align-items: center; gap: 1rem; }
        .menu-toggle { width: 44px; height: 44px; border-radius: var(--radius-lg); background: var(--bg-elevated); border: 1px solid var(--border-light); color: var(--text-secondary); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; box-shadow: var(--shadow-xs); }
        .menu-toggle:hover { border-color: var(--primary-500); color: var(--primary-500); background: var(--primary-50); }
        [data-theme="dark"] .menu-toggle:hover { background: rgba(249,112,21,0.1); }
        .menu-toggle svg { width: 20px; height: 20px; }
        .page-title { display: flex; flex-direction: column; gap: 0.25rem; }
        .page-title h1 { font-size: 1.875rem; font-weight: 800; color: var(--text-primary); letter-spacing: -0.02em; display: flex; align-items: center; gap: 0.75rem; }
        .page-title h1 svg { color: var(--primary-500); }
        .page-title p { font-size: 0.875rem; color: var(--text-tertiary); }
        .header-actions { display: flex; gap: 0.75rem; }
        .icon-btn { width: 44px; height: 44px; border-radius: var(--radius-lg); background: var(--bg-elevated); border: 1px solid var(--border-light); color: var(--text-secondary); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; box-shadow: var(--shadow-xs); }
        .icon-btn:hover { border-color: var(--primary-500); color: var(--primary-500); }

        /* Stats Grid */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1rem; margin-bottom: 1.5rem; }
        .stat-card { background: var(--bg-elevated); border: 1px solid var(--border-light); border-radius: var(--radius-2xl); padding: 1.25rem; box-shadow: var(--shadow-sm); transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .stat-card:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); }
        .stat-label { font-size: 0.8125rem; color: var(--text-tertiary); font-weight: 500; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem; }
        .stat-label svg { color: var(--primary-500); }
        .stat-value { font-family: var(--font-body); font-size: 1.75rem; font-weight: 700; color: var(--text-primary); line-height: 1.1; letter-spacing: -0.01em; }

        /* Sections */
        .section { background: var(--bg-elevated); border: 1px solid var(--border-light); border-radius: var(--radius-2xl); margin-bottom: 1.5rem; box-shadow: var(--shadow-sm); overflow: hidden; }
        .section-header { display: flex; justify-content: space-between; align-items: center; padding: 1.25rem 1.5rem; border-bottom: 1px solid var(--border-light); flex-wrap: wrap; gap: 1rem; }
        .section-header h2, .section-header h3 { font-size: 1rem; font-weight: 700; display: flex; align-items: center; gap: 0.5rem; color: var(--text-primary); }
        .section-header h2 svg, .section-header h3 svg { color: var(--primary-500); }

        /* Filters */
        .filters { display: flex; gap: 0.75rem; margin-bottom: 1rem; flex-wrap: wrap; align-items: center; }
        .filter-select { padding: 0.625rem 1rem; border-radius: var(--radius-lg); border: 1px solid var(--border-light); background: var(--bg-elevated); color: var(--text-primary); font-size: 0.875rem; font-family: var(--font-body); cursor: pointer; min-width: 180px; transition: all 0.2s; box-shadow: var(--shadow-xs); }
        .filter-select:focus { outline: none; border-color: var(--primary-500); box-shadow: 0 0 0 3px rgba(249,112,21,0.12); }
        .filter-label { font-size: 0.8125rem; color: var(--text-secondary); font-weight: 600; }
        .filter-group { display: flex; gap: 0.5rem; align-items: center; }

        /* Buttons */
        .btn { display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; padding: 0.625rem 1.25rem; font-size: 0.875rem; font-weight: 600; font-family: var(--font-body); border-radius: var(--radius-lg); cursor: pointer; transition: all 0.2s; border: none; outline: none; }
        .btn-primary { background: var(--gradient-primary); color: white; box-shadow: var(--shadow-sm), 0 0 20px rgba(249,112,21,0.2); }
        .btn-primary:hover { box-shadow: var(--shadow-md), 0 0 30px rgba(249,112,21,0.3); transform: translateY(-1px); }
        .btn-secondary { background: var(--bg-elevated); color: var(--text-primary); border: 1px solid var(--border-light); box-shadow: var(--shadow-xs); }
        .btn-secondary:hover { border-color: var(--border-medium); background: var(--bg-secondary); }
        .btn-reset { display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.625rem 1rem; border-radius: var(--radius-lg); border: 1px solid var(--border-light); background: var(--bg-elevated); color: var(--text-secondary); font-size: 0.875rem; font-weight: 500; cursor: pointer; transition: all 0.2s; font-family: var(--font-body); box-shadow: var(--shadow-xs); }
        .btn-reset:hover { border-color: var(--primary-500); color: var(--primary-500); background: var(--primary-50); }
        [data-theme="dark"] .btn-reset:hover { background: rgba(249,112,21,0.1); }

        /* Sort Dropdown */
        .sort-dropdown { position: relative; }
        .sort-trigger { padding: 0.625rem 1rem; border-radius: var(--radius-lg); border: 1px solid var(--border-light); background: var(--bg-elevated); color: var(--text-primary); font-size: 0.875rem; font-weight: 500; cursor: pointer; display: flex; align-items: center; gap: 0.5rem; transition: all 0.2s; font-family: var(--font-body); box-shadow: var(--shadow-xs); }
        .sort-trigger:hover { border-color: var(--primary-500); color: var(--primary-500); }
        .sort-trigger svg { width: 16px; height: 16px; }
        .sort-menu { position: absolute; top: 100%; right: 0; margin-top: 0.5rem; background: var(--bg-elevated); border: 1px solid var(--border-light); border-radius: var(--radius-xl); box-shadow: var(--shadow-xl); min-width: 200px; z-index: 10; opacity: 0; visibility: hidden; transform: translateY(-8px); transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); overflow: hidden; }
        .sort-dropdown.open .sort-menu { opacity: 1; visibility: visible; transform: translateY(0); }
        .sort-option { padding: 0.75rem 1rem; font-size: 0.875rem; color: var(--text-secondary); cursor: pointer; transition: all 0.15s; border-bottom: 1px solid var(--border-light); }
        .sort-option:last-child { border-bottom: none; }
        .sort-option:hover { background: var(--bg-secondary); color: var(--text-primary); }
        .sort-option.active { color: var(--primary-500); font-weight: 600; }

        /* Table */
        .table-container { background: var(--bg-elevated); border: 1px solid var(--border-light); border-radius: var(--radius-2xl); overflow: hidden; box-shadow: var(--shadow-sm); margin-bottom: 1.5rem; }
        table { width: 100%; border-collapse: collapse; }
        thead { background: var(--bg-secondary); border-bottom: 1px solid var(--border-light); }
        th { padding: 0.875rem 1.125rem; text-align: left; font-size: 0.75rem; font-weight: 600; color: var(--text-tertiary); text-transform: uppercase; letter-spacing: 0.05em; }
        td { padding: 0.875rem 1.125rem; border-top: 1px solid var(--border-light); font-size: 0.875rem; color: var(--text-primary); }
        tbody tr { transition: background 0.2s; }
        tbody tr:hover { background: var(--bg-secondary); }
        tbody tr:first-child td { border-top: none; }
        
        .manager-cell { display: flex; align-items: center; gap: 0.75rem; }
        .manager-avatar { width: 36px; height: 36px; border-radius: var(--radius-lg); display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 0.95rem; flex-shrink: 0; }
        .manager-info h4 { font-size: 0.875rem; font-weight: 600; color: var(--text-primary); }
        .manager-info p { font-size: 0.75rem; color: var(--text-tertiary); margin-top: 1px; }

        .performance-badge { display: inline-flex; align-items: center; gap: 0.35rem; padding: 0.32rem 0.65rem; border-radius: var(--radius-md); font-size: 0.8rem; font-weight: 600; }
        .performance-badge svg { width: 14px; height: 14px; }
        .performance-badge.positive { background: var(--success-50); color: var(--success-500); }
        .performance-badge.negative { background: var(--error-50); color: var(--error-500); }
        [data-theme="dark"] .performance-badge.positive { background: rgba(16,185,129,0.15); }
        [data-theme="dark"] .performance-badge.negative { background: rgba(239,68,68,0.15); }

        .service-tags { display: flex; gap: 0.5rem; flex-wrap: wrap; }
        .service-tag { padding: 0.3rem 0.6rem; border-radius: var(--radius-md); font-size: 0.75rem; font-weight: 500; background: var(--bg-secondary); color: var(--text-secondary); border: 1px solid var(--border-light); }

        .btn-action { padding: 0.45rem 0.9rem; border-radius: var(--radius-lg); border: 1px solid var(--border-light); background: var(--bg-elevated); color: var(--text-primary); font-size: 0.8125rem; font-weight: 600; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; gap: 0.5rem; font-family: var(--font-body); box-shadow: var(--shadow-xs); }
        .btn-action:hover { background: var(--primary-500); border-color: var(--primary-500); color: white; box-shadow: var(--shadow-sm), 0 0 16px rgba(249,112,21,0.2); }
        .btn-action svg { width: 14px; height: 14px; }

        .empty-state { text-align: center; padding: 3rem !important; color: var(--text-tertiary); }

        /* Comparison presets */
        .compare-preset { padding: 0.5rem 1rem; background: var(--bg-secondary); border: 1px solid var(--border-light); border-radius: var(--radius-lg); font-family: var(--font-body); font-size: 0.8125rem; font-weight: 600; color: var(--text-secondary); cursor: pointer; transition: all 0.2s; }
        .compare-preset:hover { border-color: var(--border-medium); color: var(--text-primary); }
        .compare-preset.active { background: var(--primary-500); border-color: var(--primary-500); color: #fff; box-shadow: 0 0 16px rgba(249,112,21,0.25); }

        .comp-delta { font-family: var(--font-mono); font-size: 0.8125rem; font-weight: 500; margin-top: 0.5rem; display: flex; align-items: center; gap: 4px; }
        .comp-delta.positive { color: var(--success-500); }
        .comp-delta.negative { color: var(--error-500); }
        .comp-delta svg { width: 14px; height: 14px; }

        .comparison-chart-card { background: var(--bg-elevated); border: 1px solid var(--border-light); border-radius: var(--radius-2xl); padding: 1.5rem; position: relative; box-shadow: var(--shadow-sm); }
        .comparison-chart-legend { display: flex; align-items: center; gap: 16px; margin-bottom: 12px; font-size: 0.8125rem; color: var(--text-tertiary); font-weight: 500; }
        .comparison-chart-wrap { position: relative; height: 260px; min-height: 260px; max-height: 260px; overflow: hidden; }
        #comparisonChart { display: block; width: 100% !important; height: 260px !important; max-height: 260px; }

        /* Restaurants Section */
        .restaurants-section { background: var(--bg-elevated); border: 1px solid var(--border-light); border-radius: var(--radius-2xl); padding: 1.5rem; margin-top: 2rem; box-shadow: var(--shadow-sm); }
        .restaurants-section h3 { font-size: 1.125rem; font-weight: 700; margin-bottom: 1.5rem; color: var(--text-primary); }

        /* Toast */
        .toast { position: fixed; bottom: 2rem; right: 2rem; padding: 1rem 1.5rem; background: var(--bg-elevated); border: 1px solid var(--border-light); border-radius: var(--radius-xl); box-shadow: var(--shadow-xl); display: flex; align-items: center; gap: 0.75rem; z-index: 2000; animation: fadeInUp 0.3s ease; }
        .toast.success { border-left: 4px solid var(--success-500); }
        .toast.success svg { color: var(--success-500); }
        .toast.error { border-left: 4px solid var(--error-500); }
        .toast.error svg { color: var(--error-500); }

        @media (max-width: 768px) {
            .container { padding: 1rem; }
            .stats-grid { grid-template-columns: 1fr; }
            .filters { flex-direction: column; align-items: stretch; }
            .filter-select, .btn-reset { width: 100%; }
            th, td { padding: 0.75rem 0.5rem; }
            .comparison-chart-wrap { height: 220px; min-height: 220px; max-height: 220px; }
            #comparisonChart { height: 220px !important; max-height: 220px; }
        }
    </style>
</head>
<body>
    <!-- Sidebar Overlay -->
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>
    
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-brand">
                <div class="sidebar-logo"><img src="/static/LOGO.png" alt="Logo"></div>
            </div>
            <div class="sidebar-user">
                <div class="sidebar-avatar" id="sidebarAvatar">A</div>
                <div class="sidebar-user-info">
                    <h3 id="sidebarUserName">Admin</h3>
                    <p><span class="role-dot"></span><span id="sidebarUserRole">Administrador</span></p>
                </div>
            </div>
            <div class="org-switcher" id="orgSwitcher" style="margin-top:12px;padding:10px 12px;background:var(--bg-secondary);border:1px solid var(--border-light);border-radius:var(--radius-lg);cursor:pointer">
                <div style="display:flex;align-items:center;gap:10px">
                    <div style="width:32px;height:32px;border-radius:8px;background:var(--gradient-primary);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;font-size:11px" id="orgAvatar">ORG</div>
                    <div style="flex:1;min-width:0">
                        <div style="font-size:13px;font-weight:600;color:var(--text-primary);overflow:hidden;text-overflow:ellipsis;white-space:nowrap" id="orgName">Minha Empresa</div>
                        <div style="font-size:10px;color:var(--text-tertiary);display:flex;align-items:center;gap:4px"><span style="padding:1px 6px;background:rgba(249,112,21,.1);color:#f97015;border-radius:4px;font-weight:700;font-size:9px" id="planBadge">PRO</span><span id="orgStoreCount">0 lojas</span></div>
                    </div>
                </div>
            </div>
        </div>
        
        <nav class="sidebar-nav">
            <div class="sidebar-section">
                <div class="sidebar-section-title">Menu</div>
                <a href="/" class="sidebar-link">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/></svg>
                    <span>Clientes</span>
                </a>
                <a href="/grupos" class="sidebar-link">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/></svg>
                    <span>Grupos</span>
                </a>
            </div>
            
            <div class="sidebar-section">
                <div class="sidebar-section-title">Admin</div>
                <a href="/comparativo" class="sidebar-link active">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>
                    <span>Comparativo</span>
                </a>
                <a href="/admin" class="sidebar-link">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                    <span>Configurações</span>
                </a>
                <a href="/squads" class="sidebar-link">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/></svg>
                    <span>Squads</span>
                </a>
                <a href="/hidden-stores" class="sidebar-link">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21"/></svg>
                    <span>Lojas Ocultas</span>
                </a>
            </div>
        </nav>
        
        <div class="sidebar-footer">
            <button class="sidebar-footer-btn" onclick="logout()">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
                </svg>
                Sair
            </button>
        </div>
    </aside>
    
    <!-- Main Content -->
    <div class="container">
        <div class="header animate-in">
            <div class="header-left">
                <button class="menu-toggle" onclick="toggleSidebar()">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
                    </svg>
                </button>
                <div class="page-title">
                    <h1>
                        <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>
                        Comparativo
                    </h1>
                    <p>Análise comparativa por gestor e período</p>
                </div>
            </div>
            <div class="header-actions">
                <button class="icon-btn" onclick="toggleTheme()" title="Alternar tema">
                    <svg id="sunIcon" style="display: none;" width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"/>
                    </svg>
                    <svg id="moonIcon" width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/>
                    </svg>
                </button>
            </div>
        </div>
        
        <!-- Period Comparison Section -->
        <div class="section animate-in" id="periodComparison" style="margin-bottom:1.5rem;">
            <div class="section-header">
                <h3>
                    <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>
                    Comparativo por Período
                </h3>
                <div style="display:flex;gap:8px;flex-wrap:wrap">
                    <button class="compare-preset active" data-preset="week" onclick="loadComparison('week')">Semana</button>
                    <button class="compare-preset" data-preset="month" onclick="loadComparison('month')">Mês</button>
                    <button class="compare-preset" data-preset="quarter" onclick="loadComparison('quarter')">Trimestre</button>
                </div>
            </div>
            <div style="padding:1.5rem">
            <div class="stats-grid" id="comparisonCards" style="margin-bottom:16px">
                <div class="stat-card"><div class="stat-label">Faturamento</div><div class="stat-value" id="compRevenue">--</div><div class="comp-delta" id="compRevenueDelta"></div></div>
                <div class="stat-card"><div class="stat-label">Pedidos</div><div class="stat-value" id="compOrders">--</div><div class="comp-delta" id="compOrdersDelta"></div></div>
                <div class="stat-card"><div class="stat-label">Ticket Médio</div><div class="stat-value" id="compTicket">--</div><div class="comp-delta" id="compTicketDelta"></div></div>
                <div class="stat-card"><div class="stat-label">Cancelamentos</div><div class="stat-value" id="compCancelled">--</div><div class="comp-delta" id="compCancelledDelta"></div></div>
            </div>
            <div class="comparison-chart-card">
                <div class="comparison-chart-legend">
                    <span id="compPeriodALabel" style="display:flex;align-items:center;gap:4px"><span style="width:12px;height:3px;background:var(--text-muted);border-radius:2px;display:inline-block"></span>Período anterior</span>
                    <span id="compPeriodBLabel" style="display:flex;align-items:center;gap:4px"><span style="width:12px;height:3px;background:#f97015;border-radius:2px;display:inline-block"></span>Período atual</span>
                </div>
                <div class="comparison-chart-wrap">
                    <canvas id="comparisonChart" width="1200" height="260"></canvas>
                </div>
            </div>
            </div>
        </div>
        
        <!-- Summary Stats -->
        <div class="stats-grid animate-in">
            <div class="stat-card">
                <div class="stat-label">
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
                    </svg>
                    Total de Gestores
                </div>
                <div class="stat-value" id="totalManagers">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                    </svg>
                    Total de Lojas
                </div>
                <div class="stat-value" id="totalStores">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    Faturamento Total
                </div>
                <div class="stat-value" id="totalRevenue">R$ 0,00</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/>
                    </svg>
                    Desempenho Médio
                </div>
                <div class="stat-value" id="avgPerformance">-</div>
            </div>
        </div>
        
        <!-- Filters -->
        <div class="filters">
            <div class="filter-group">
                <span class="filter-label">Mês:</span>
                <select id="monthFilter" class="filter-select" onchange="applyFilters()">
                    <option value="">Todos os Meses</option>
                </select>
            </div>
            
            <div class="sort-dropdown" id="sortDropdown">
                <button class="sort-trigger" onclick="toggleSortDropdown()">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4h13M3 8h9m-9 4h6m4 0l4-4m0 0l4 4m-4-4v12"/>
                    </svg>
                    <span id="currentSort">Nome (A-Z)</span>
                </button>
                <div class="sort-menu">
                    <div class="sort-option active" onclick="changeSortOrder('name-asc')">Nome (A-Z)</div>
                    <div class="sort-option" onclick="changeSortOrder('name-desc')">Nome (Z-A)</div>
                    <div class="sort-option" onclick="changeSortOrder('revenue-desc')">Vendas (Maior)</div>
                    <div class="sort-option" onclick="changeSortOrder('revenue-asc')">Vendas (Menor)</div>
                    
                    <div class="sort-option" onclick="changeSortOrder('stores-desc')">Nº de Lojas (Maior)</div>
                </div>
            </div>
            
            <button class="btn-reset" onclick="resetFilters()">
                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                </svg>
                Limpar Filtros
            </button>
        </div>
        
        <!-- Managers Table -->
        <div class="table-container animate-in">
            <table>
                <thead>
                    <tr>
                        <th>Gestor</th>
                        <th>Nº Lojas</th>
                        <th>Faturamento</th>
                        <th>Desempenho</th>
                        <th>Serviços</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody id="managersTable">
                    <tr>
                        <td colspan="6" class="empty-state">Carregando dados...</td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <!-- Restaurants Section (Hidden by default) -->
        <div class="restaurants-section" id="restaurantsSection" style="display: none;">
            <h3 id="restaurantsSectionTitle">Restaurantes</h3>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Restaurante</th>
                            <th>Faturamento</th>
                            
                            <th>Pedidos</th>
                            <th>Tendência</th>
                        </tr>
                    </thead>
                    <tbody id="restaurantsTable">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="orgSwitcherModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);backdrop-filter:blur(4px);z-index:2500;align-items:center;justify-content:center;padding:16px" onclick="if(event.target===this)closeOrgModal('orgSwitcherModal')">
        <div style="width:100%;max-width:520px;background:var(--bg-card);border:1px solid var(--border-subtle);border-radius:16px;box-shadow:var(--shadow-lg);overflow:hidden">
            <div style="display:flex;align-items:center;justify-content:space-between;padding:16px 20px;border-bottom:1px solid var(--border-subtle)">
                <h3 style="font-size:1rem;font-weight:700;color:var(--text-primary)">Organizacoes</h3>
                <button class="btn-reset" style="padding:6px 10px" onclick="closeOrgModal('orgSwitcherModal')">Fechar</button>
            </div>
            <div style="padding:16px">
                <div id="orgListContainer" style="display:grid;gap:8px">
                    <div class="empty-state" style="padding:1rem;border:1px dashed var(--border-subtle);border-radius:12px">Carregando organizacoes...</div>
                </div>
            </div>
            <div style="padding:12px 16px;border-top:1px solid var(--border-subtle);display:flex;justify-content:flex-end">
                <button class="btn-reset" style="padding:8px 12px;border-color:#f97015;color:#f97015" onclick="openCreateOrgModal()">Criar Organizacao</button>
            </div>
        </div>
    </div>

    <div id="createOrgModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);backdrop-filter:blur(4px);z-index:2501;align-items:center;justify-content:center;padding:16px" onclick="if(event.target===this)closeOrgModal('createOrgModal')">
        <div style="width:100%;max-width:520px;background:var(--bg-card);border:1px solid var(--border-subtle);border-radius:16px;box-shadow:var(--shadow-lg);overflow:hidden">
            <div style="display:flex;align-items:center;justify-content:space-between;padding:16px 20px;border-bottom:1px solid var(--border-subtle)">
                <h3 style="font-size:1rem;font-weight:700;color:var(--text-primary)">Criar Organizacao</h3>
                <button class="btn-reset" style="padding:6px 10px" onclick="closeOrgModal('createOrgModal')">Fechar</button>
            </div>
            <div style="padding:16px">
                <label style="display:block;font-size:12px;font-weight:600;color:var(--text-muted);margin-bottom:6px">Nome da Organizacao *</label>
                <input id="newOrgName" type="text" style="width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--border-subtle);background:var(--bg-base);color:var(--text-primary);font-family:inherit" placeholder="Ex.: Operacao Sul">
                <label style="display:flex;align-items:flex-start;gap:8px;font-size:.8125rem;color:var(--text-secondary);cursor:pointer;margin-top:10px">
                    <input type="checkbox" id="newOrgCopyUsers" checked style="margin-top:2px">
                    <span>Manter usuarios existentes na nova organizacao.</span>
                </label>
            </div>
            <div style="padding:12px 16px;border-top:1px solid var(--border-subtle);display:flex;justify-content:flex-end;gap:8px">
                <button class="btn-reset" style="padding:8px 12px" onclick="closeOrgModal('createOrgModal')">Cancelar</button>
                <button class="btn-reset" style="padding:8px 12px;border-color:#f97015;color:#f97015" onclick="createOrganization()">Criar</button>
            </div>
        </div>
    </div>

    <script>
        // Global 401 interceptor
        const _origFetch = window.fetch;
        window.fetch = async function(...args) {
            const response = await _origFetch.apply(this, args);
            if (response.status === 401 && !String(args[0]).includes('/api/login')) {
                window.location.href = '/login';
            }
            return response;
        };
        let managersData = [];
        let allRestaurants = [];
        let currentSortOrder = 'name-asc';
        let currentMonthFilter = ''; // Track current month filter
        let currentOrgId = null;
        let organizationsCache = [];
        const servicesMap = {
            'delivery': 'Delivery',
            'takeout': 'Retirada',
            'indoor': 'Salão'
        };
        
        function escapeOrgText(value) {
            return String(value || '')
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        function openOrgModal(id) {
            const el = document.getElementById(id);
            if (el) el.style.display = 'flex';
        }

        function closeOrgModal(id) {
            const el = document.getElementById(id);
            if (el) el.style.display = 'none';
        }

        async function loadOrganizations(renderToModal = false) {
            try {
                const response = await fetch('/api/orgs');
                const data = await response.json();
                if (!response.ok || !data.success) {
                    if (renderToModal) {
                        const container = document.getElementById('orgListContainer');
                        if (container) container.innerHTML = '<div class="empty-state" style="padding:1rem;border:1px dashed var(--border-subtle);border-radius:12px">Nao foi possivel carregar organizacoes</div>';
                    }
                    return;
                }
                organizationsCache = Array.isArray(data.organizations) ? data.organizations : [];
                if (renderToModal) renderOrganizationOptions();
            } catch (error) {
                if (renderToModal) {
                    const container = document.getElementById('orgListContainer');
                    if (container) container.innerHTML = '<div class="empty-state" style="padding:1rem;border:1px dashed var(--border-subtle);border-radius:12px">Erro ao carregar organizacoes</div>';
                }
            }
        }

        function renderOrganizationOptions() {
            const container = document.getElementById('orgListContainer');
            if (!container) return;
            if (!organizationsCache.length) {
                container.innerHTML = '<div class="empty-state" style="padding:1rem;border:1px dashed var(--border-subtle);border-radius:12px">Nenhuma organizacao encontrada</div>';
                return;
            }
            container.innerHTML = organizationsCache.map(org => {
                const orgId = Number(org.id);
                const isCurrent = Number(currentOrgId) === orgId;
                const plan = String(org.plan || '-').toUpperCase();
                const role = String(org.org_role || 'viewer').toUpperCase();
                return `
                    <button class="btn-reset" style="width:100%;display:flex;justify-content:space-between;align-items:center;gap:12px;padding:10px 12px;border:1px solid var(--border-subtle);border-radius:10px;background:var(--bg-base);cursor:pointer;text-align:left" onclick="switchOrganization(${orgId})" ${isCurrent ? 'disabled' : ''}>
                        <span style="display:flex;flex-direction:column;align-items:flex-start;gap:2px">
                            <span style="font-weight:700;color:var(--text-primary)">${escapeOrgText(org.name || 'Organizacao')}</span>
                            <span style="font-size:11px;color:var(--text-muted)">${escapeOrgText(plan)} / ${escapeOrgText(role)}</span>
                        </span>
                        ${isCurrent ? '<span class="performance-badge positive">Atual</span>' : ''}
                    </button>
                `;
            }).join('');
        }

        async function openOrgSwitcherModal() {
            await loadOrganizations(true);
            openOrgModal('orgSwitcherModal');
        }

        async function switchOrganization(orgId) {
            try {
                const response = await fetch('/api/orgs/switch', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ org_id: orgId })
                });
                const data = await response.json();
                if (!response.ok || !data.success) {
                    showToast(data.error || 'Falha ao trocar organizacao', 'error');
                    return;
                }
                currentOrgId = Number(orgId);
                closeOrgModal('orgSwitcherModal');
                await checkUser();
                await loadData(currentMonthFilter);
                const activePreset = document.querySelector('.compare-preset.active')?.dataset?.preset || 'week';
                await loadComparison(activePreset);
                showToast('Organizacao atualizada', 'success');
            } catch (error) {
                showToast('Erro de conexao ao trocar organizacao', 'error');
            }
        }

        function openCreateOrgModal() {
            closeOrgModal('orgSwitcherModal');
            const orgInput = document.getElementById('newOrgName');
            if (orgInput) orgInput.value = '';
            const copyInput = document.getElementById('newOrgCopyUsers');
            if (copyInput) copyInput.checked = true;
            openOrgModal('createOrgModal');
            if (orgInput) orgInput.focus();
        }

        async function createOrganization() {
            const orgName = (document.getElementById('newOrgName')?.value || '').trim();
            const copyUsers = !!document.getElementById('newOrgCopyUsers')?.checked;
            if (!orgName) {
                showToast('Informe o nome da organizacao', 'error');
                return;
            }
            try {
                const response = await fetch('/api/orgs', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ org_name: orgName, copy_users: copyUsers })
                });
                const data = await response.json();
                if (!response.ok || !data.success) {
                    showToast(data.error || 'Falha ao criar organizacao', 'error');
                    return;
                }
                currentOrgId = Number(data.org_id || (data.organization && data.organization.id) || currentOrgId);
                closeOrgModal('createOrgModal');
                await checkUser();
                await loadData(currentMonthFilter);
                const activePreset = document.querySelector('.compare-preset.active')?.dataset?.preset || 'week';
                await loadComparison(activePreset);
                const copyErrors = Array.isArray(data.copy_errors) ? data.copy_errors.length : 0;
                if (copyErrors > 0) showToast(`Organizacao criada com ${copyErrors} falha(s) ao vincular usuarios`, 'error');
                else showToast('Organizacao criada com sucesso', 'success');
            } catch (error) {
                showToast('Erro de conexao ao criar organizacao', 'error');
            }
        }

        async function refreshOrgStoreCount() {
            try {
                const response = await fetch('/api/org/ifood-config');
                const data = await response.json();
                const merchants = Array.isArray(data?.config?.merchants) ? data.config.merchants : [];
                const orgStoreCount = document.getElementById('orgStoreCount');
                if (orgStoreCount) orgStoreCount.textContent = `${merchants.length} lojas`;
            } catch (error) {
                const orgStoreCount = document.getElementById('orgStoreCount');
                if (orgStoreCount) orgStoreCount.textContent = '0 lojas';
            }
        }

        // Generate month options
        function generateMonthOptions() {
            const select = document.getElementById('monthFilter');
            const months = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 
                          'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
            const currentYear = new Date().getFullYear();
            
            for (let year = currentYear; year >= currentYear - 2; year--) {
                months.forEach((month, idx) => {
                    const option = document.createElement('option');
                    option.value = `${year}-${String(idx + 1).padStart(2, '0')}`;
                    option.textContent = `${month} ${year}`;
                    select.appendChild(option);
                });
            }
        }
        
        // Load data with optional month filter
        async function loadData(monthFilter = '') {
            try {
                // Build URL with month filter if specified
                let url = '/api/restaurants';
                if (monthFilter) {
                    // Extract month number from YYYY-MM format
                    const [year, month] = monthFilter.split('-');
                    url += `?month=${month}`;
                }
                
                const response = await fetch(url);
                if (response.status === 401) { window.location.href = '/login'; return; }
                const data = await response.json();
                
                if (data.success && data.restaurants) {
                    allRestaurants = data.restaurants;
                    processManagersData(allRestaurants);
                    renderManagersTable();
                } else {
                    document.getElementById('managersTable').innerHTML = '<tr><td colspan="6" class="empty-state">Nenhum dado disponível</td></tr>';
                }
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('managersTable').innerHTML = '<tr><td colspan="6" class="empty-state">Erro ao carregar dados</td></tr>';
            }
        }
        
        // Process managers data
        function processManagersData(restaurants) {
            const managersMap = {};
            
            restaurants.forEach(r => {
                const manager = r.manager || 'Sem Gestor';
                if (!managersMap[manager]) {
                    managersMap[manager] = {
                        name: manager,
                        restaurants: [],
                        totalRevenue: 0,
                        positiveCount: 0,
                        negativeCount: 0,
                        services: new Set()
                    };
                }
                
                managersMap[manager].restaurants.push(r);
                managersMap[manager].totalRevenue += r.metrics?.valor_bruto || 0;
                
                const trend = r.metrics?.trends?.vendas || 0;
                if (trend > 0) managersMap[manager].positiveCount++;
                else if (trend < 0) managersMap[manager].negativeCount++;
                
                // Collect services
                if (r.services) {
                    r.services.forEach(s => managersMap[manager].services.add(s));
                }
            });
            
            managersData = Object.values(managersMap);
            applySorting(); // Apply current sort order
            
            // Update summary
            document.getElementById('totalManagers').textContent = managersData.length;
            document.getElementById('totalStores').textContent = restaurants.length;
            document.getElementById('totalRevenue').textContent = formatCurrency(
                managersData.reduce((sum, m) => sum + m.totalRevenue, 0)
            );
            
            const avgPositive = managersData.reduce((sum, m) => sum + m.positiveCount, 0) / managersData.length;
            const avgNegative = managersData.reduce((sum, m) => sum + m.negativeCount, 0) / managersData.length;
            document.getElementById('avgPerformance').textContent = 
                avgPositive > avgNegative ? `+${avgPositive.toFixed(1)} positivos` : `${avgNegative.toFixed(1)} negativos`;
        }
        
        // Format currency
        function formatCurrency(value) {
            return new Intl.NumberFormat('pt-BR', { 
                style: 'currency', 
                currency: 'BRL',
                minimumFractionDigits: 2 
            }).format(value);
        }
        
        // Get avatar color
        function getAvatarColor(name) {
            const colors = ['#f97015', '#f97015', '#f59e0b', '#84cc16', '#22c55e', '#10b981', '#14b8a6', '#06b6d4', '#0ea5e9', '#3b82f6', '#6366f1', '#8b5cf6', '#a855f7', '#d946ef', '#ec4899'];
            const hash = name.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0);
            return colors[hash % colors.length];
        }
        
        // Render managers table
        function renderManagersTable() {
            const tbody = document.getElementById('managersTable');
            
            if (managersData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="empty-state">Nenhum gestor encontrado</td></tr>';
                return;
            }
            
            tbody.innerHTML = managersData.map(manager => {
                const storeCount = manager.restaurants.length;
                const isPositive = manager.positiveCount > manager.negativeCount;
                const services = Array.from(manager.services);
                
                return `
                    <tr>
                        <td>
                            <div class="manager-cell">
                                <div class="manager-avatar" style="background: ${getAvatarColor(manager.name)}">
                                    ${manager.name.charAt(0).toUpperCase()}
                                </div>
                                <div class="manager-info">
                                    <h4>${manager.name}</h4>
                                    <p>${storeCount} restaurante${storeCount !== 1 ? 's' : ''}</p>
                                </div>
                            </div>
                        </td>
                        <td><strong>${storeCount}</strong></td>
                        <td><strong>${formatCurrency(manager.totalRevenue)}</strong></td>
                        <td>
                            <span class="performance-badge ${isPositive ? 'positive' : 'negative'}">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${isPositive ? 'M5 10l7-7m0 0l7 7m-7-7v18' : 'M19 14l-7 7m0 0l-7-7m7 7V3'}"/>
                                </svg>
                                ${manager.positiveCount} positivo${manager.positiveCount !== 1 ? 's' : ''} / ${manager.negativeCount} negativo${manager.negativeCount !== 1 ? 's' : ''}
                            </span>
                        </td>
                        <td>
                            <div class="service-tags">
                                ${services.map(s => `<span class="service-tag ${s}">${servicesMap[s] || s}</span>`).join('')}
                                ${services.length === 0 ? '<span class="service-tag">-</span>' : ''}
                            </div>
                        </td>
                        <td>
                            <button class="btn-action" onclick="showManagerRestaurants('${manager.name.replace(/'/g, "\\'")}')">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>
                                Ver Lojas
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        // Show restaurants for a manager
        function showManagerRestaurants(managerName) {
            const manager = managersData.find(m => m.name === managerName);
            if (!manager) return;
            
            document.getElementById('restaurantsSectionTitle').innerHTML = `
                Restaurantes de ${managerName}
            `;
            
            const tbody = document.getElementById('restaurantsTable');
            tbody.innerHTML = manager.restaurants.map(r => {
                const metrics = r.metrics || {};
                const trend = metrics.trends?.vendas || 0;
                const isPositive = trend >= 0;
                
                return `
                    <tr>
                        <td>
                            <div class="manager-cell">
                                <div class="manager-avatar" style="background: ${getAvatarColor(r.name)}">${(r.name || 'R')[0].toUpperCase()}</div>
                                <div class="manager-info">
                                    <h4>${r.name}</h4>
                                    <p>ID: ${r.id?.substring(0, 8) || '-'}...</p>
                                </div>
                            </div>
                        </td>
                        <td><strong>${formatCurrency(metrics.valor_bruto || 0)}</strong></td>
                        <td></td>
                        <td>${metrics.total_pedidos || 0}</td>
                        <td>
                            <span class="performance-badge ${isPositive ? 'positive' : 'negative'}">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${isPositive ? 'M5 10l7-7m0 0l7 7m-7-7v18' : 'M19 14l-7 7m0 0l-7-7m7 7V3'}"/>
                                </svg>
                                ${trend >= 0 ? '+' : ''}${trend.toFixed(1)}%
                            </span>
                        </td>
                    </tr>
                `;
            }).join('');
            
            document.getElementById('restaurantsSection').style.display = 'block';
            document.getElementById('restaurantsSection').scrollIntoView({ behavior: 'smooth' });
        }
        
        // Apply filters
        function applyFilters() {
            const monthFilter = document.getElementById('monthFilter').value;
            currentMonthFilter = monthFilter;
            
            // Reload data with the selected month filter
            loadData(monthFilter);
        }
        
        // Reset filters
        function resetFilters() {
            document.getElementById('monthFilter').value = '';
            currentSortOrder = 'name-asc';
            currentMonthFilter = '';
            document.getElementById('currentSort').textContent = 'Nome (A-Z)';
            updateSortActiveState();
            
            // Reload data without filter
            loadData();
        }
        
        // Toggle sort dropdown
        function toggleSortDropdown() {
            const dropdown = document.getElementById('sortDropdown');
            const isOpen = dropdown.classList.contains('open');
            
            // Close if clicking outside
            if (!isOpen) {
                dropdown.classList.add('open');
                
                // Add click listener to close when clicking outside
                setTimeout(() => {
                    document.addEventListener('click', closeSortOnClickOutside);
                }, 0);
            } else {
                dropdown.classList.remove('open');
                document.removeEventListener('click', closeSortOnClickOutside);
            }
        }
        
        function closeSortOnClickOutside(event) {
            const dropdown = document.getElementById('sortDropdown');
            if (!dropdown.contains(event.target)) {
                dropdown.classList.remove('open');
                document.removeEventListener('click', closeSortOnClickOutside);
            }
        }
        
        // Change sort order
        function changeSortOrder(order) {
            currentSortOrder = order;
            
            const sortLabels = {
                'name-asc': 'Nome (A-Z)',
                'name-desc': 'Nome (Z-A)',
                'revenue-desc': 'Vendas (Maior)',
                'revenue-asc': 'Vendas (Menor)',
                'ticket-desc': 'Ticket Médio (Maior)',
                'stores-desc': 'Nº de Lojas (Maior)'
            };
            
            document.getElementById('currentSort').textContent = sortLabels[order];
            updateSortActiveState();
            applySorting();
            renderManagersTable();
            
            // Close dropdown
            document.getElementById('sortDropdown').classList.remove('open');
            document.removeEventListener('click', closeSortOnClickOutside);
        }
        
        // Update active sort option visual state
        function updateSortActiveState() {
            document.querySelectorAll('.sort-option').forEach((option, index) => {
                const orders = ['name-asc', 'name-desc', 'revenue-desc', 'revenue-asc', 'ticket-desc', 'stores-desc'];
                if (orders[index] === currentSortOrder) {
                    option.classList.add('active');
                } else {
                    option.classList.remove('active');
                }
            });
        }
        
        // Apply sorting to managers data
        function applySorting() {
            switch(currentSortOrder) {
                case 'name-asc':
                    managersData.sort((a, b) => a.name.localeCompare(b.name));
                    break;
                case 'name-desc':
                    managersData.sort((a, b) => b.name.localeCompare(a.name));
                    break;
                case 'revenue-desc':
                    managersData.sort((a, b) => b.totalRevenue - a.totalRevenue);
                    break;
                case 'revenue-asc':
                    managersData.sort((a, b) => a.totalRevenue - b.totalRevenue);
                    break;
                case 'ticket-desc':
                    managersData.sort((a, b) => {
                        const avgA = a.totalRevenue / a.restaurants.length;
                        const avgB = b.totalRevenue / b.restaurants.length;
                        return avgB - avgA;
                    });
                    break;
                case 'stores-desc':
                    managersData.sort((a, b) => b.restaurants.length - a.restaurants.length);
                    break;
            }
        }
        
        // Toast notification
        function showToast(message, type = 'success') {
            document.querySelectorAll('.toast').forEach(t => t.remove());
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${type === 'success' ? 'M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z' : 'M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z'}"/>
                </svg>
                <span>${message}</span>
            `;
            toast.style.color = type === 'success' ? 'var(--green)' : 'var(--red)';
            document.body.appendChild(toast);
            setTimeout(() => { toast.style.opacity = '0'; setTimeout(() => toast.remove(), 300); }, 3000);
        }
        
        // Theme toggle
        function toggleTheme() {
            const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
            document.getElementById('sunIcon').style.display = theme === 'dark' ? 'block' : 'none';
            document.getElementById('moonIcon').style.display = theme === 'dark' ? 'none' : 'block';
            if (compChart && lastComparisonTheme !== theme) {
                renderComparisonChart(lastComparisonDailyA, lastComparisonDailyB);
            }
        }
        
        // Sidebar toggle
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
            document.getElementById('sidebarOverlay').classList.toggle('show');
        }
        
        function closeSidebar() {
            document.getElementById('sidebar').classList.remove('open');
            document.getElementById('sidebarOverlay').classList.remove('show');
        }
        
        // Logout
        function logout() {
            fetch('/api/logout', { method: 'POST' })
                .then(() => {
                    localStorage.removeItem('currentUser');
                    window.location.href = '/login';
                })
                .catch(() => {
                    window.location.href = '/login';
                });
        }
        async function checkUser() {
            try {
                const r = await fetch('/api/me');
                const data = await r.json();
                if (!(data.success && data.user)) {
                    window.location.href = '/login';
                    return;
                }
                const u = data.user;
                document.getElementById('sidebarUserName').textContent = u.name || u.username || 'Usuario';
                document.getElementById('sidebarAvatar').textContent = (u.name || u.username || 'U').charAt(0).toUpperCase();
                document.getElementById('sidebarUserRole').textContent = u.role === 'admin' ? 'Administrador' : 'Usuario';
                
                if (u.role === 'admin') {
                    const adminEl = document.getElementById('adminSection');
                    if (adminEl) adminEl.style.display = 'block';
                } else {
                    window.location.href = '/dashboard';
                    return;
                }

                currentOrgId = Number(data.org_id || currentOrgId || 0);
                const org = data.org || {};
                if (org.name) {
                    const orgName = document.getElementById('orgName');
                    if (orgName) orgName.textContent = org.name;
                    const orgAvatar = document.getElementById('orgAvatar');
                    if (orgAvatar) {
                        const orgInitials = String(org.name).split(' ').map(v => v[0]).join('').slice(0, 3).toUpperCase();
                        orgAvatar.textContent = orgInitials || 'ORG';
                    }
                }
                if (org.plan_display || org.plan) {
                    const planBadge = document.getElementById('planBadge');
                    if (planBadge) planBadge.textContent = String(org.plan_display || org.plan).toUpperCase();
                }

                await refreshOrgStoreCount();
                await loadOrganizations(false);
            } catch (err) {
                console.error('Auth check failed:', err);
                window.location.href = '/login';
            }
        }
        
        // ============================================================
        // PERIOD COMPARISON
        // ============================================================
        let compChart = null;
        let comparisonRequestId = 0;
        let comparisonAbortController = null;
        let comparisonInFlightPreset = null;
        let lastComparisonDailyA = [];
        let lastComparisonDailyB = [];
        let lastComparisonTheme = null;
        let lastComparisonSignature = '';
        
        async function loadComparison(preset) {
            if (comparisonInFlightPreset === preset) return;
            comparisonInFlightPreset = preset;
            // Update active button
            document.querySelectorAll('.compare-preset').forEach(b => b.classList.toggle('active', b.dataset.preset === preset));
            const requestId = ++comparisonRequestId;
            if (comparisonAbortController) {
                comparisonAbortController.abort();
            }
            comparisonAbortController = new AbortController();
            const { signal } = comparisonAbortController;

            try {
                // Load summary and chart data in parallel
                const [resp, chartResp] = await Promise.all([
                    fetch(`/api/analytics/compare?preset=${preset}&restaurant_id=all`, { signal }),
                    fetch(`/api/analytics/daily-comparison?preset=${preset}&restaurant_id=all`, { signal })
                ]);
                
                if (requestId !== comparisonRequestId) return;

                if (resp.ok) {
                    const data = await resp.json();
                    if (data.success && data.totals) {
                        const ta = data.totals.period_a;
                        const tb = data.totals.period_b;
                        const d = data.totals.deltas;
                        
                        document.getElementById('compRevenue').textContent = formatCurrency(tb.revenue);
                        document.getElementById('compOrders').textContent = tb.orders;
                        document.getElementById('compTicket').textContent = formatCurrency(tb.ticket || 0);
                        document.getElementById('compCancelled').textContent = tb.cancelled;
                        
                        setDelta('compRevenueDelta', d.revenue);
                        setDelta('compOrdersDelta', d.orders);
                        setDelta('compCancelledDelta', d.cancelled, true);
                        
                        // Ticket delta
                        const ticketDelta = tb.ticket && ta.ticket ? {
                            percent: ta.ticket > 0 ? ((tb.ticket - ta.ticket) / ta.ticket * 100).toFixed(1) : 0,
                            absolute: (tb.ticket - ta.ticket).toFixed(2)
                        } : {percent: 0, absolute: 0};
                        setDelta('compTicketDelta', ticketDelta);
                        
                        // Update labels
                        const fmtDate = d => d.split('-').reverse().slice(0,2).join('/');
                        document.getElementById('compPeriodALabel').innerHTML = `<span style="width:12px;height:3px;background:var(--text-muted);border-radius:2px;display:inline-block"></span>${fmtDate(data.period_a.start)} - ${fmtDate(data.period_a.end)}`;
                        document.getElementById('compPeriodBLabel').innerHTML = `<span style="width:12px;height:3px;background:#f97015;border-radius:2px;display:inline-block"></span>${fmtDate(data.period_b.start)} - ${fmtDate(data.period_b.end)}`;
                    }
                }
                
                if (chartResp.ok) {
                    const chartData = await chartResp.json();
                    if (chartData.success) {
                        const dailyA = Array.isArray(chartData?.period_a?.daily) ? chartData.period_a.daily : [];
                        const dailyB = Array.isArray(chartData?.period_b?.daily) ? chartData.period_b.daily : [];
                        lastComparisonDailyA = dailyA;
                        lastComparisonDailyB = dailyB;
                        renderComparisonChart(dailyA, dailyB);
                    }
                }
            } catch (e) {
                if (e.name !== 'AbortError') {
                    console.error('Comparison load error:', e);
                }
            } finally {
                if (requestId === comparisonRequestId) {
                    comparisonAbortController = null;
                }
                if (comparisonInFlightPreset === preset) {
                    comparisonInFlightPreset = null;
                }
            }
        }
        
        function setDelta(elId, delta, invert = false) {
            const el = document.getElementById(elId);
            if (!el || !delta) return;
            const pct = parseFloat(delta.percent);
            const isPositive = invert ? pct < 0 : pct > 0;
            el.className = `comp-delta ${isPositive ? 'positive' : 'negative'}`;
            el.innerHTML = `<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${isPositive ? 'M13 7h8m0 0v8m0-8l-8 8-4-4-6 6' : 'M13 17h8m0 0V9m0 8l-8-8-4 4-6-6'}"/></svg>${pct > 0 ? '+' : ''}${pct}%`;
        }
        
        function renderComparisonChart(dailyA, dailyB) {
            const ctx = document.getElementById('comparisonChart');
            if (!ctx) return;
            const safeDailyA = Array.isArray(dailyA) ? dailyA : [];
            const safeDailyB = Array.isArray(dailyB) ? dailyB : [];
            const revenueA = safeDailyA.map(d => Number(d?.revenue) || 0);
            const revenueB = safeDailyB.map(d => Number(d?.revenue) || 0);
            
            const maxLen = Math.max(safeDailyA.length, safeDailyB.length);
            const labels = Array.from({length: maxLen}, (_, i) => `Dia ${i + 1}`);
            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            const theme = isDark ? 'dark' : 'light';
            const signature = `${theme}|${JSON.stringify(revenueA)}|${JSON.stringify(revenueB)}`;
            if (signature === lastComparisonSignature) return;
            lastComparisonSignature = signature;
            lastComparisonTheme = theme;
            const targetHeight = window.matchMedia('(max-width: 768px)').matches ? 220 : 260;
            const chartWrap = ctx.parentElement;
            if (chartWrap) {
                chartWrap.style.height = `${targetHeight}px`;
                chartWrap.style.minHeight = `${targetHeight}px`;
                chartWrap.style.maxHeight = `${targetHeight}px`;
            }
            ctx.style.width = '100%';
            ctx.style.height = `${targetHeight}px`;
            ctx.width = Math.max(chartWrap?.clientWidth || ctx.clientWidth || 1200, 320);
            ctx.height = targetHeight;
            if (compChart) compChart.destroy();
            
            compChart = new Chart(ctx.getContext('2d'), {
                type: 'line',
                data: {
                    labels,
                    datasets: [
                        {
                            label: 'Período anterior',
                            data: revenueA,
                            borderColor: isDark ? '#737373' : '#a3a3a3',
                            backgroundColor: 'transparent',
                            borderWidth: 2, borderDash: [6, 4], tension: 0.3, pointRadius: 3,
                            pointBackgroundColor: isDark ? '#737373' : '#a3a3a3'
                        },
                        {
                            label: 'Período atual',
                            data: revenueB,
                            borderColor: '#f97015',
                            backgroundColor: 'rgba(249,112,21,0.08)',
                            borderWidth: 2.5, fill: true, tension: 0.3, pointRadius: 4,
                            pointBackgroundColor: '#f97015', pointBorderColor: isDark ? '#0a0a0a' : '#fff', pointBorderWidth: 2
                        }
                    ]
                },
                options: {
                    animation: false,
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { display: false }, tooltip: {
                        backgroundColor: isDark ? '#262626' : '#fff', titleColor: isDark ? '#fff' : '#171717',
                        bodyColor: isDark ? '#a3a3a3' : '#525252', borderColor: isDark ? '#404040' : '#e5e5e5',
                        borderWidth: 1, padding: 12, cornerRadius: 8,
                        callbacks: { label: c => `${c.dataset.label}: ${formatCurrency(c.parsed.y)}` }
                    }},
                    scales: {
                        x: { grid: { color: isDark ? '#1a1a1a' : '#f5f5f5' }, ticks: { color: isDark ? '#525252' : '#a3a3a3', font: { size: 11 } } },
                        y: { grid: { color: isDark ? '#1a1a1a' : '#f5f5f5' }, ticks: { color: isDark ? '#525252' : '#a3a3a3', callback: v => 'R$ ' + (v >= 1000 ? (v/1000).toFixed(0) + 'k' : v) } }
                    }
                }
            });
        }
        
        // Initialize
        (async function init() {
            const theme = localStorage.getItem('theme') || 'dark';
            document.documentElement.setAttribute('data-theme', theme);
            document.getElementById('sunIcon').style.display = theme === 'dark' ? 'block' : 'none';
            document.getElementById('moonIcon').style.display = theme === 'dark' ? 'none' : 'block';
            
            generateMonthOptions();
            const orgSwitcher = document.getElementById('orgSwitcher');
            if (orgSwitcher) orgSwitcher.addEventListener('click', openOrgSwitcherModal);
            await checkUser();
            Promise.all([loadData(), loadComparison('week')]); // Load in parallel
            
            // Initialize sort dropdown
            setTimeout(() => {
                updateSortActiveState();
            }, 100);
            document.addEventListener('keydown', e => {
                if (e.key === 'Escape') {
                    closeOrgModal('orgSwitcherModal');
                    closeOrgModal('createOrgModal');
                    closeSidebar();
                }
            });
        })();
    </script>
</body>
</html>
